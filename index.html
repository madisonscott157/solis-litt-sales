<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Solis/Litt Sales</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.bootstrap5.min.css" rel="stylesheet">
    <!-- Persistent File Storage CSS -->
    <link rel="stylesheet" href="public/styles.css">
    
    <style>
        .drop-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .drop-zone:hover {
            border-color: #0056b3;
            background-color: rgba(25, 25, 112, 0.1);
        }
        .drop-zone.dragover {
            border-color: #28a745;
            background-color: #e8f5e9;
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .overlap-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
            text-align: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .overlap-1 { background-color: #007bff; }
        .overlap-2 { background-color: #28a745; }
        .overlap-3 { background-color: #ffc107; color: black; }
        .overlap-4 { background-color: #dc3545; }
        .overlap-5plus { background-color: #6f42c1; }
        .custom-column {
            background-color: #e3f2fd !important;
        }
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
        }
        .editable-cell:hover {
            border: 1px solid #007bff;
            background-color: rgba(25, 25, 112, 0.1);
        }
        .editing {
            background-color: #fff3cd !important;
        }
        .stats-card {
            background: #1e3a8a;
            color: #ff6600;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px;
            text-align: center;
            min-width: 120px;
        }
        .stats-card h6 {
            font-size: 11px;
            margin: 0 0 2px 0;
            opacity: 0.9;
        }
        .stats-card .stat-number {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .stats-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .shortlist-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 1px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .excel-table {
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background-color: white;
        }
        .excel-table th {
            background-color: #f2f2f2;
            border: 1px solid #d0d7de;
            padding: 8px 12px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .excel-table td {
            border: 1px solid #d0d7de;
            padding: 6px 8px;
            text-align: center;
            background-color: white;
            white-space: nowrap;
        }
        .excel-table tbody tr:hover {
            background-color: rgba(25, 25, 112, 0.1);
        }
        
        /* Vet column text wrapping */
        .excel-table .vet-cell {
            white-space: normal !important;
            word-wrap: break-word !important;
            max-width: 600px; /* Mobile/tablet default */
            min-width: 120px;
            line-height: 1.4;
            padding: 8px 6px !important;
        }
        
        /* Desktop - larger Vet column */
        @media (min-width: 1025px) {
            .excel-table .vet-cell {
                max-width: 1000px;
            }
        }
        .excel-table .horse-info {
            text-align: left;
            min-width: 120px;
        }
        .excel-table .hip-column {
            width: 60px;
            font-weight: bold;
        }
        .grade-cell {
            font-weight: bold;
            min-width: 80px;
        }
        .grade-A { background-color: #d4edda !important; color: #155724; }
        .grade-A-plus { background-color: #c3e6cb !important; color: #155724; }
        .grade-B { background-color: #cce5ff !important; color: #004085; }
        .grade-B-plus { background-color: #b3d9ff !important; color: #004085; }
        .grade-C { background-color: #fff3cd !important; color: #856404; }
        .grade-D { background-color: #f8d7da !important; color: #721c24; }
        .table-container {
            max-height: 95vh;
            overflow: auto;
            border: 2px solid rgba(25, 25, 112, 0.2);
            border-radius: 8px;
            width: 100%;
            margin: 0 auto;
        }
        .shortlist-header {
            background-color: #e3f2fd !important;
            color: #1976d2;
            font-weight: bold;
        }
        
        /* Enhanced table features */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px !important;
        }
        .sortable-header:hover {
            background-color: #f8f9fa !important;
        }
        .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .sortable-header:hover .sort-icon {
            opacity: 0.7;
        }
        .sort-icon.active {
            opacity: 1;
            color: #007bff;
        }
        
        /* Filter row */
        .filter-row {
            background-color: rgba(25, 25, 112, 0.1);
        }
        .filter-input {
            width: 100%;
            border: 1px solid rgba(25, 25, 112, 0.2);
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 3px;
        }
        .filter-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        /* Navy button theme */
        .btn-primary, .btn-secondary, .btn-outline-primary, .btn-outline-secondary, .btn-outline-info, .btn-success {
            background-color: #1e3a8a !important;
            border-color: #1e3a8a !important;
            color: white !important;
        }
        .btn-primary:hover, .btn-secondary:hover, .btn-outline-primary:hover, .btn-outline-secondary:hover, .btn-outline-info:hover, .btn-success:hover {
            background-color: #1e40af !important;
            border-color: #1e40af !important;
            color: white !important;
        }
        
        /* Column management */
        .column-controls {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .column-checkbox {
            margin-right: 15px;
            margin-bottom: 8px;
        }
        .column-checkbox input {
            margin-right: 5px;
        }
        .column-reorder {
            max-width: 200px;
        }
        
        /* Drag and drop */
        .dragging {
            opacity: 0.5;
        }
        .drop-indicator {
            width: 3px;
            background-color: #007bff;
            position: absolute;
            top: 0;
            bottom: 0;
            z-index: 1000;
        }
        
        /* iPad and touch device optimizations */
        @media (max-width: 1024px) and (orientation: portrait), 
               (max-width: 1366px) and (orientation: landscape) {
            /* iPad specific styles */
            .btn {
                min-height: 44px; /* Apple's recommended touch target size */
                padding: 8px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            .btn-sm {
                min-height: 38px;
                padding: 6px 12px;
                font-size: 14px;
            }
            .form-control, .form-select {
                min-height: 44px;
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 8px 12px;
            }
            .table-container {
                max-height: 140vh; /* Large phones/small tablets portrait */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                overflow: auto;
            }
            .excel-table th, .excel-table td {
                padding: 8px 12px;
                min-width: 80px;
            }
            .editable-cell {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            .filter-input {
                min-height: 38px;
                font-size: 14px;
                padding: 6px 10px;
            }
            /* Better touch targets for column controls */
            .column-checkbox {
                margin: 8px 12px 8px 0;
                font-size: 14px;
            }
            .column-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-right: 8px;
            }
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .excel-table {
                font-size: 12px;
            }
            .excel-table th, .excel-table td {
                padding: 6px 8px;
                min-width: 60px;
            }
            .table-container {
                max-height: 94vh; /* Small phones portrait */
            }
            .column-controls {
                padding: 15px;
            }
            .stats-card {
                min-width: 120px;
                padding: 8px 12px;
                margin: 8px 4px;
            }
            .stats-card h6 {
                font-size: 12px;
            }
            .stats-card .stat-number {
                font-size: 18px;
            }
        }
        
        @media (max-width: 576px) {
            .excel-table {
                font-size: 11px;
            }
            .excel-table th, .excel-table td {
                padding: 4px 6px;
                min-width: 50px;
            }
            .btn {
                font-size: 14px;
                padding: 6px 12px;
            }
        }

        /* Hip number links */
        .hip-column a {
            color: inherit !important;
            text-decoration: underline !important;
            cursor: pointer;
        }
        
        .hip-column a:hover {
            text-decoration: underline !important;
            opacity: 0.8;
        }
        
        /* Non-editable cells */
        .non-editable-cell {
            cursor: default !important;
        }
        
        /* View-only mode styles */
        .view-only-mode .editable-cell {
            cursor: default !important;
            pointer-events: none;
        }
        .view-only-mode .editable-cell:hover {
            background-color: inherit !important;
            border: 1px solid transparent !important;
        }
        
        /* Edit mode indicator */
        .edit-mode-active {
            border-left: 4px solid #28a745 !important;
        }
        .edit-mode-active .card-header {
            background-color: #d4edda;
        }
        
        /* Touch-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects on touch devices */
            .editable-cell:hover {
                background-color: inherit !important;
                border: 1px solid transparent !important;
            }
            /* Add active/focus states for touch */
            .editable-cell:active,
            .editable-cell:focus {
                background-color: #f0f8ff !important;
                border: 2px solid #007bff !important;
                outline: none;
            }
            .btn:active {
                transform: scale(0.98);
            }
        }
        
        /* Edit cell enhancements */
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        .editable-cell:hover {
            background-color: #f0f8ff !important;
            border: 1px solid #007bff !important;
        }
        .editable-cell.editing {
            padding: 0 !important;
        }
        .edit-input, .edit-select {
            width: 100%;
            height: 100%;
            border: 2px solid #007bff;
            padding: 4px 8px;
            font-size: 16px; /* Prevent zoom on iOS */
            background-color: white;
            border-radius: 4px;
            box-sizing: border-box;
            margin: 0;
        }
        .edit-input:focus, .edit-select:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        
        /* Modal optimizations for iPad */
        @media (max-width: 1024px) {
            .modal-dialog {
                margin: 20px auto;
                max-width: 90%;
            }
            .modal-body {
                padding: 20px;
            }
            .modal-header .btn-close {
                padding: 12px;
                margin: -12px;
            }
        }
        
        /* Dropdown optimizations */
        .dropdown-menu {
            font-size: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dropdown-item {
            padding: 12px 16px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        /* File upload area improvements */
        .file-upload {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .file-upload:hover,
        .file-upload.dragover {
            background-color: #f8f9fa;
            border-color: #0056b3;
        }
        
        /* iPad & Mobile Fixes - Both orientations */
        @media (max-width: 1024px) {
            /* Make table container fill available space dynamically */
            .table-container {
                /* Height will be set by JavaScript for better control */
                min-height: 400px !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch !important;
                position: relative !important;
            }
            
            /* Fix sticky headers for mobile Safari */
            .excel-table th {
                position: -webkit-sticky !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 100 !important;
                background-color: #f8f9fa !important;
                border-bottom: 1px solid #d0d7de !important;
            }
            
            /* Keep normal border collapse on mobile but force sticky */
            .excel-table {
                border-collapse: collapse !important;
            }
            
            /* Override for sticky headers specifically */
            .excel-table thead {
                display: table-header-group !important;
                position: relative !important;
            }
            
            .excel-table thead th {
                position: -webkit-sticky !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 100 !important;
                background-color: #f8f9fa !important;
            }
        }
        
        /* Specific fixes for mobile portrait mode */
        @media (max-width: 1024px) and (orientation: portrait) {
            .table-container {
                /* Let JavaScript handle height dynamically */
                min-height: 600px !important;
                overflow-y: auto !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Force different sticky approach for portrait iOS */
            .excel-table {
                position: relative !important;
            }
            
            .excel-table thead {
                position: -webkit-sticky !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 999 !important;
            }
            
            .excel-table thead th {
                position: -webkit-sticky !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 999 !important;
                background: #f8f9fa !important;
                border-bottom: 2px solid #d0d7de !important;
            }
        }
        
        /* Landscape mobile adjustments */
        @media (max-width: 1024px) and (orientation: landscape) {
            .table-container {
                /* Let JavaScript handle height dynamically */
                min-height: 400px !important;
            }
            
            /* Compact button layout - preserve functionality */
            .btn {
                min-height: 44px; /* Touch target size */
                padding: 8px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
                margin: 2px;
                border-radius: 4px;
            }
            
            /* Smaller buttons for space efficiency */
            .btn-sm {
                min-height: 38px;
                padding: 6px 12px;
                font-size: 14px;
            }
            
            /* More compact action sections */
            .stats-row {
                gap: 5px !important;
                margin: 5px 0 !important;
            }
            
            .stats-card {
                padding: 4px 8px !important;
                margin: 2px !important;
                min-width: 100px !important;
            }
            
            .stats-card h6 {
                font-size: 10px !important;
                margin: 0 !important;
            }
            
            .stats-card .stat-number {
                font-size: 16px !important;
            }
            
            /* Container fixes */
            .table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                width: 100% !important;
            }
            
            /* Force table to behave properly */
            #mainTable {
                display: table !important; 
                width: auto !important;
                table-layout: auto !important;
                border-collapse: collapse !important;
            }
            
            #mainTable thead {
                display: table-header-group !important;
            }
            
            #mainTable tbody {
                display: table-row-group !important;
            }
            
            #mainTable tr {
                display: table-row !important;
                height: auto !important;
            }
            
            #mainTable th,
            #mainTable td {
                display: table-cell !important;
                padding: 4px 6px !important;
                font-size: 12px !important;
                border: 1px solid #ddd !important;
                background-color: white !important;
                vertical-align: top !important;
                text-align: left !important;
                box-sizing: border-box !important;
                word-wrap: break-word !important;
                white-space: normal !important;
                line-height: 1.2 !important;
                max-width: none !important;
                width: auto !important;
            }
            
            /* Header styling - no wrap for headers */
            #mainTable th {
                background-color: #f8f9fa !important;
                font-weight: bold !important;
                border-bottom: 2px solid #007bff !important;
                white-space: nowrap !important;
                padding: 6px 8px !important;
            }
            
            /* Dynamic column widths based on header text width */
            #mainTable th:nth-child(1), #mainTable td:nth-child(1) { max-width: 50px; }    /* Hip - short */
            #mainTable th:nth-child(2), #mainTable td:nth-child(2) { max-width: 120px; }   /* Name */
            #mainTable th:nth-child(3), #mainTable td:nth-child(3) { max-width: 80px; }    /* Sire */
            #mainTable th:nth-child(4), #mainTable td:nth-child(4) { max-width: 80px; }    /* Dam */
            #mainTable th:nth-child(5), #mainTable td:nth-child(5) { max-width: 40px; }    /* Sex */
            #mainTable th:nth-child(6), #mainTable td:nth-child(6) { max-width: 50px; }    /* YOB */
            #mainTable th:nth-child(7), #mainTable td:nth-child(7) { max-width: 100px; }   /* Consignor */
            #mainTable th:nth-child(8), #mainTable td:nth-child(8) { max-width: 80px; }    /* Notes */
            
            /* Additional columns */
            #mainTable th:nth-child(n+9), #mainTable td:nth-child(n+9) { 
                max-width: 80px;
            }
        }
        
        /* Portrait orientation - more compact */
        @media (max-width: 1024px) and (orientation: portrait) {
            #mainTable th,
            #mainTable td {
                font-size: 11px !important;
                padding: 3px 4px !important;
            }
        }
        
        /* Landscape orientation - slightly more space */
        @media (max-width: 1024px) and (orientation: landscape) {
            .container-fluid {
                padding: 10px !important;
            }
            
            #mainTable th,
            #mainTable td {
                font-size: 12px !important;
                padding: 4px 6px !important;
            }
            
            /* Slightly wider max-widths in landscape */
            #mainTable th:nth-child(2), #mainTable td:nth-child(2) { max-width: 140px; }   /* Name */
            #mainTable th:nth-child(3), #mainTable td:nth-child(3) { max-width: 100px; }   /* Sire */
            #mainTable th:nth-child(4), #mainTable td:nth-child(4) { max-width: 100px; }   /* Dam */
            #mainTable th:nth-child(7), #mainTable td:nth-child(7) { max-width: 120px; }   /* Consignor */
            #mainTable th:nth-child(8), #mainTable td:nth-child(8) { max-width: 100px; }   /* Notes */
        }

        /* Mobile admin button - show on mobile/tablet, hide on desktop */
        .mobile-admin-btn {
            display: inline-block;
        }
        
        @media (min-width: 769px) and (pointer: fine) {
            .mobile-admin-btn {
                display: none !important;
            }
        }

        /* iPad improvements */
        @media (max-width: 1024px) {
            /* Smaller action buttons on iPad */
            .btn {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }
            
            .btn-sm {
                font-size: 10px !important;
                padding: 2px 6px !important;
            }
            
            /* Keep text on one line */
            .btn, .btn-sm {
                white-space: nowrap !important;
            }
            
            /* Make 815 admin button very light grey - both orientations */
            span#admin815btn.mobile-admin-btn {
                color: #f0f0f0 !important;
                background: transparent !important;
                border: 1px solid #f0f0f0 !important;
                font-size: 8px !important;
            }
            
            /* Center table text and reduce row height */
            #mainTable td, #mainTable th {
                text-align: center !important;
                vertical-align: middle !important;
                padding: 3px 4px !important;
                line-height: 1.1 !important;
                height: 32px !important;
            }
            
            /* Smaller font in table for better fit */
            #mainTable {
                font-size: 12px !important;
            }
            
            /* Make delete button a small dot on iPad */
            .delete-horse-btn {
                width: 12px !important;
                height: 12px !important;
                padding: 0 !important;
                border-radius: 50% !important;
                font-size: 6px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 0 auto !important;
                min-width: 12px !important;
                min-height: 12px !important;
                max-width: 12px !important;
                max-height: 12px !important;
            }
            
            .delete-horse-btn i {
                font-size: 4px !important;
            }
        }
        
        /* Horizontal iPad specific styles - reduce row height even more */
        @media (max-width: 1024px) and (orientation: landscape) {
            .table-container {
                max-height: 85vh; /* All mobile devices landscape */
            }
            
            /* Further reduce row height for horizontal display */
            #mainTable td, #mainTable th {
                padding: 1px 1px !important;
                line-height: 0.8 !important;
                height: 18px !important;
                font-size: 9px !important;
            }
            
        }
        
        /* Hide overlap indicators and trash icons on vertical iPad display */
        @media (max-width: 1024px) and (orientation: portrait) {
            .overlap-indicator {
                display: none !important;
            }
            .delete-horse-btn i {
                display: none !important;
            }
        }
        
        /* NUCLEAR OPTION - Force table layout on iPad */
        @media (max-width: 1024px) {
            #mainTable th,
            #mainTable td {
                display: table-cell !important;
                width: auto !important;
                float: none !important;
                position: static !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                bottom: auto !important;
            }
        }

        /* Print styles for table printing */
        @media print {
            @page {
                @top-left { content: none; }
                @top-center { content: none; }
                @top-right { content: none; }
                @bottom-left { content: none; }
                @bottom-center { content: none; }
                @bottom-right { content: none; }
                margin: 0.25in !important;
            }
            
            /* Desktop print settings */
            @media print and (min-width: 1024px) {
                @page {
                    size: 11in 8.5in;
                }
                
                html, body {
                    width: 11in !important;
                    height: 8.5in !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                }
            }
            
            /* Mobile/tablet print settings */
            @media print and (max-width: 1023px) {
                @page {
                    size: landscape;
                }
                
                html, body {
                    width: 100% !important;
                    height: auto !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    position: relative !important;
                }
            }
            
            /* Additional rules to hide browser headers/footers */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* Show print title */
            #printTitle {
                display: block !important;
                text-align: center !important;
                font-weight: bold !important;
                margin: 0 !important;
                padding: 0 !important;
                font-size: 20px !important;
                color: #000 !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
            }
            
            /* Hide non-essential elements when printing */
            .navbar, .btn, .form-control, .dropdown, .modal, 
            .stats-row, .file-upload-section, .admin-controls,
            .alert, .toast, nav, header, footer, .card-header {
                display: none !important;
            }
            
            /* Hide all other body children except our containers */
            body > *:not(.container-fluid):not(#printTitle) {
                display: none !important;
            }
            
            .container-fluid > *:not(.row) {
                display: none !important;
            }
            
            .row > *:not(.col-12) {
                display: none !important;
            }
            
            .col-12 > *:not(.card) {
                display: none !important;
            }
            
            .card > *:not(.card-body) {
                display: none !important;
            }
            
            .card-body > *:not(.table-container) {
                display: none !important;
            }
            
            /* Optimize table for print */
            .excel-table {
                width: 100% !important;
                font-size: 11px !important;
                border-collapse: collapse;
                table-layout: fixed !important;
                page-break-inside: auto;
                max-width: 100% !important;
            }
            
            .excel-table th,
            .excel-table td {
                padding: 20px 6px !important;
                border: 1px solid #000 !important;
                font-size: 11px !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                vertical-align: top !important;
                height: auto !important;
                min-height: 90px !important;
                line-height: 1.5 !important;
                background-color: white !important;
                max-width: none !important;
            }
            
            .excel-table th {
                background-color: #f8f8f8 !important;
                color: #000 !important;
                font-weight: bold;
                padding: 8px 4px !important;
                height: auto !important;
                min-height: 30px !important;
                max-height: 35px !important;
                line-height: 1.2 !important;
                text-align: center !important;
            }
            
            /* Hide delete column completely from print */
            .delete-horse-btn,
            td:has(.delete-horse-btn),
            .excel-table td:last-child,
            .excel-table th:last-child {
                display: none !important;
            }
            
            /* Dynamic column widths using CSS custom properties */
            .excel-table th,
            .excel-table td {
                width: auto !important;
            }
            
            /* Dynamic width application using column index */
            .excel-table th:nth-child(1), .excel-table td:nth-child(1) { width: var(--print-col-1-width, 4%) !important; }
            .excel-table th:nth-child(2), .excel-table td:nth-child(2) { width: var(--print-col-2-width, 4%) !important; }
            .excel-table th:nth-child(3), .excel-table td:nth-child(3) { width: var(--print-col-3-width, 4%) !important; }
            .excel-table th:nth-child(4), .excel-table td:nth-child(4) { width: var(--print-col-4-width, 4%) !important; }
            .excel-table th:nth-child(5), .excel-table td:nth-child(5) { width: var(--print-col-5-width, 4%) !important; }
            .excel-table th:nth-child(6), .excel-table td:nth-child(6) { width: var(--print-col-6-width, 4%) !important; }
            .excel-table th:nth-child(7), .excel-table td:nth-child(7) { width: var(--print-col-7-width, 4%) !important; }
            .excel-table th:nth-child(8), .excel-table td:nth-child(8) { width: var(--print-col-8-width, 4%) !important; }
            .excel-table th:nth-child(9), .excel-table td:nth-child(9) { width: var(--print-col-9-width, 4%) !important; }
            .excel-table th:nth-child(10), .excel-table td:nth-child(10) { width: var(--print-col-10-width, 4%) !important; }
            .excel-table th:nth-child(11), .excel-table td:nth-child(11) { width: var(--print-col-11-width, 4%) !important; }
            .excel-table th:nth-child(12), .excel-table td:nth-child(12) { width: var(--print-col-12-width, 4%) !important; }
            .excel-table th:nth-child(13), .excel-table td:nth-child(13) { width: var(--print-col-13-width, 4%) !important; }
            .excel-table th:nth-child(14), .excel-table td:nth-child(14) { width: var(--print-col-14-width, 4%) !important; }
            .excel-table th:nth-child(15), .excel-table td:nth-child(15) { width: var(--print-col-15-width, 4%) !important; }
            .excel-table th:nth-child(16), .excel-table td:nth-child(16) { width: var(--print-col-16-width, 4%) !important; }
            .excel-table th:nth-child(17), .excel-table td:nth-child(17) { width: var(--print-col-17-width, 4%) !important; }
            .excel-table th:nth-child(18), .excel-table td:nth-child(18) { width: var(--print-col-18-width, 4%) !important; }
            .excel-table th:nth-child(19), .excel-table td:nth-child(19) { width: var(--print-col-19-width, 4%) !important; }
            .excel-table th:nth-child(20), .excel-table td:nth-child(20) { width: var(--print-col-20-width, 4%) !important; }
            
            /* Styling based on column type classes */
            .excel-table .print-sire-header,
            .excel-table .print-sire-cell,
            .excel-table .print-dam-header,
            .excel-table .print-dam-cell,
            .excel-table .print-consignor-header,
            .excel-table .print-consignor-cell { 
                text-align: center !important; 
            }
            
            /* Remove underlines from Hip column content */
            .excel-table .print-hip-cell a,
            .excel-table .print-hip-cell * {
                text-decoration: none !important;
                border-bottom: none !important;
                color: #000 !important;
            }
            
            /* Change Sex header to S for print */
            .excel-table .print-sex-header {
                font-size: 0 !important;
            }
            .excel-table .print-sex-header::after {
                content: "S" !important;
                font-size: 11px !important;
                display: inline !important;
                visibility: visible !important;
            }
            
            /* Hide sort arrows and icons from headers */
            .excel-table th .sort-icon,
            .excel-table th .fas,
            .excel-table th .fa,
            .excel-table th i,
            .excel-table th .sortable-header::after,
            .excel-table th::after {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Ensure table container takes full width */
            .table-container {
                overflow: visible !important;
                max-height: none !important;
                width: 100% !important;
            }
            
            /* Force table to fit on page with absolute positioning */
            .container-fluid {
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
                position: absolute !important;
                top: 25px !important;
                left: 0 !important;
            }
            
            /* Remove ALL hover effects and colors for print */
            .excel-table tbody tr:hover,
            .editable-cell:hover,
            .grade-A, .grade-A-plus, .grade-B, .grade-B-plus, .grade-C,
            .grade-cell {
                background-color: white !important;
                color: #000 !important;
            }
            
            /* Force table to start at absolute top */
            .excel-table {
                position: relative !important;
                top: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: avoid !important;
            }
            
            /* Mobile-specific table adjustments */
            @media print and (max-width: 1023px) {
                .excel-table {
                    font-size: 9px !important;
                    table-layout: fixed !important;
                }
                
                .excel-table th,
                .excel-table td {
                    padding: 2px 1px !important;
                    font-size: 9px !important;
                    line-height: 1.2 !important;
                }
                
                /* Make sure vet column text wraps properly on mobile print */
                .excel-table .vet-cell {
                    word-wrap: break-word !important;
                    overflow-wrap: break-word !important;
                    white-space: normal !important;
                }
            }
            
            /* Force headers to absolute top and repeat on pages */
            .excel-table thead {
                display: table-header-group !important;
                position: relative !important;
                top: 0 !important;
                z-index: 1000 !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                background-color: white !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            
            /* Force header row to top */
            .excel-table thead tr {
                position: relative !important;
                top: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            
            /* Force header cells to top */  
            .excel-table thead th {
                position: relative !important;
                top: 0 !important;
                margin: 0 !important;
                padding: 5px !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                background-color: white !important;
            }
            
            .excel-table tbody {
                display: table-row-group !important;
            }
            
            /* Force header row to be first and at top of page */
            .excel-table thead tr:first-child {
                page-break-before: avoid !important;
                break-before: avoid !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                position: relative !important;
                top: 0 !important;
            }
            
            /* Ensure no content appears before headers */
            .excel-table thead tr:first-child th {
                page-break-before: avoid !important;
                break-before: avoid !important;
                margin-top: 0 !important;
                padding-top: 2px !important;
                vertical-align: top !important;
            }
            
            /* Force table container to start at top */
            .table-container {
                margin-top: 0 !important;
                padding-top: 0 !important;
                position: relative !important;
                top: 0 !important;
            }
            
            /* Page break handling - allow rows to break across pages */
            .excel-table tbody tr {
                page-break-inside: auto;
                break-inside: auto;
            }
            
            /* Much taller rows for better readability */
            .excel-table tbody tr {
                min-height: 90px !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            
            /* Clean card styling for print */
            .card {
                border: none !important;
                background: white !important;
                box-shadow: none !important;
            }
            
            .card-body {
                padding: 0 !important;
            }
        }
        
        
        /* PIN Access Modal Styles */
        .pin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        
        .pin-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .pin-input {
            font-size: 24px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 200px;
            letter-spacing: 8px;
        }
        
        .pin-submit {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .pin-submit:hover {
            background: #0056b3;
        }
        
        .pin-error {
            color: #dc3545;
            margin-top: 10px;
            display: none;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Site Access PIN Modal -->
    <div id="siteAccessModal" class="pin-modal">
        <div class="pin-modal-content">
            <h2>Access Required</h2>
            <p>Please enter the PIN to access Solis/Litt Sales</p>
            <input type="password" id="siteAccessInput" class="pin-input" maxlength="5" placeholder="•••••">
            <br>
            <button onclick="checkSitePin()" class="pin-submit">Enter</button>
            <div id="siteAccessError" class="pin-error">Incorrect PIN. Please try again.</div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">Solis/Litt Sales</h1>
            </div>
        </div>

        <!-- Sale Day Selector -->
        <div class="row" id="saleDaySection">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Sale Management <span id="admin815btn" class="mobile-admin-btn" style="margin-left: 10px; padding: 1px 4px; border-radius: 2px; font-size: 8px; font-weight: bold; cursor: pointer; color: #d3d3d3 !important; background: transparent !important; border: 1px solid #d3d3d3 !important;">815</span></h5>
                        <div>
                            <button class="btn btn-primary btn-sm" id="newSaleBtn">
                                <i class="fas fa-plus"></i> New Sale Day
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="saleSelector" class="form-label">Current Sale:</label>
                                <select class="form-select" id="saleSelector">
                                    <option value="">Select a sale day...</option>
                                </select>
                            </div>
                            <div class="col-md-8" id="currentSaleInfo">
                                <small class="text-muted">No sale selected</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row" id="uploadSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Shortlist Files</h5>
                        <div>
                            <button class="btn btn-primary btn-sm" id="uploadBtn">
                                <i class="fas fa-upload"></i> Upload Files
                            </button>
                            <button class="btn btn-success btn-sm ms-2" id="combineBtn" disabled>
                                <i class="fas fa-merge"></i> Combine
                            </button>
                            <button class="btn btn-secondary btn-sm ms-2" id="clearBtn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls" style="display: none;">
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="row" id="statsSection" style="display: none;">
            <div class="col-12">
                <div class="stats-row">
                    <div class="stats-card">
                        <h6>Unique Horses</h6>
                        <div class="stat-number" id="uniqueHorses">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Colts</h6>
                        <div class="stat-number" id="coltCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Fillies</h6>
                        <div class="stat-number" id="fillyCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Vetting</h6>
                        <div class="stat-number" id="vettingCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Overlapping</h6>
                        <div class="stat-number" id="overlappingHorses">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Shortlists</h6>
                        <div class="stat-number" id="shortlistCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Purchased</h6>
                        <div class="stat-number" id="purchasedCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="row" id="controlsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                        <h3>Combined Shortlist</h3>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" id="editModeBtn" title="Click to enable editing">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-primary" id="exportCsvBtn">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button class="btn" id="printTableBtn" style="background-color: #1e3a8a; color: white; border-color: #1e3a8a;">
                                <i class="fas fa-print"></i> Print Table
                            </button>
                            <button class="btn btn-primary" id="addColumnBtn">
                                <i class="fas fa-plus"></i> Add Column
                            </button>
                            <button class="btn btn-success" id="addHorseBtn">
                                <i class="fas fa-plus"></i> Add New Horse
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Column Controls -->
                        <div class="column-controls" id="columnControls">
                            <div class="row">
                                <div class="col-md-7">
                                    <h6><i class="fas fa-eye"></i> Show/Hide Columns:</h6>
                                    <div id="columnCheckboxes" class="d-flex flex-wrap">
                                        <!-- Column checkboxes will be inserted here -->
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <h6>Actions:</h6>
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-secondary w-100" id="selectAllBtn">Select All</button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-secondary w-100" id="resetColumnsBtn">Reset</button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-info w-100" id="toggleFiltersBtn">
                                                <i class="fas fa-filter"></i> Filters
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm w-100" id="clearFiltersBtn" style="background-color: transparent; border: 1px solid #ff6600; color: #ff6600;">
                                                <i class="fas fa-eraser"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6><i class="fas fa-arrows-alt"></i> Reorder Columns:</h6>
                                    <select class="form-select column-reorder mb-2" id="columnReorder">
                                        <option value="">Select column to move...</option>
                                    </select>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-primary" id="moveLeftBtn">← Left</button>
                                        <button class="btn btn-sm btn-outline-primary" id="moveRightBtn">Right →</button>
                        <button class="btn btn-sm" id="undoBtn" disabled title="Nothing to undo" style="background-color: #ff8c42; border-color: #ff8c42; color: white; margin-left: 8px;">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="table-container">
                            <table id="mainTable" class="excel-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- New Sale Day Modal -->
    <div class="modal fade" id="newSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Sale Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="saleName" class="form-label">Sale Name</label>
                        <input type="text" class="form-control" id="saleName" placeholder="e.g. Keeneland September 2024">
                    </div>
                    <div class="mb-3">
                        <label for="saleDate" class="form-label">Sale Date</label>
                        <input type="date" class="form-control" id="saleDate">
                    </div>
                    <div class="mb-3">
                        <label for="saleLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="saleLocation" placeholder="e.g. Keeneland, Lexington, KY">
                    </div>
                    <div class="mb-3">
                        <label for="hipUrlTemplate" class="form-label">Hip 1 PDF URL (Optional)</label>
                        <input type="url" class="form-control" id="hipUrlTemplate" placeholder="e.g. http://apps.keeneland.com/sales/k224/pdfs/1.pdf">
                        <div class="form-text">If provided, all hip numbers will become clickable links. Supports various URL patterns including PDFs (1.pdf → 3.pdf) and path-based URLs (/1 → /3).</div>
                    </div>
                    <div class="mb-3">
                        <label for="saleDataFile" class="form-label">Import Sale Data (Optional)</label>
                        <input type="file" class="form-control" id="saleDataFile" accept=".csv,.xlsx,.xls">
                        <div class="form-text">Upload a CSV or Excel file to populate the sale with existing data. The file will be displayed exactly as-is.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createSaleBtn">Create Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Sales Modal -->
    <div class="modal fade" id="editSalesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Sales Days</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="salesList">
                        <!-- Sales will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Sale Modal -->
    <div class="modal fade" id="renameSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rename Sale Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSaleName" class="form-label">Sale Name</label>
                        <input type="text" class="form-control" id="editSaleName">
                    </div>
                    <div class="mb-3">
                        <label for="editSaleDate" class="form-label">Sale Date</label>
                        <input type="date" class="form-control" id="editSaleDate">
                    </div>
                    <div class="mb-3">
                        <label for="editSaleLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="editSaleLocation">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSaleChangesBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Custom Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="columnName" class="form-label">Column Name</label>
                        <input type="text" class="form-control" id="columnName" placeholder="Enter column name">
                    </div>
                    <div class="mb-3">
                        <label for="columnType" class="form-label">Column Type</label>
                        <select class="form-select" id="columnType">
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="select">Dropdown</option>
                        </select>
                    </div>
                    <div class="mb-3" id="selectOptions" style="display: none;">
                        <label for="optionsList" class="form-label">Options (comma-separated)</label>
                        <input type="text" class="form-control" id="optionsList" placeholder="Option1, Option2, Option3">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveColumnBtn">Add Column</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div class="modal fade" id="nameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shortlist Owner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Who's shortlist is this?</p>
                    <div class="mb-3">
                        <label for="shortlistOwner" class="form-label">Name</label>
                        <input type="text" class="form-control" id="shortlistOwner" placeholder="Enter person's name">
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">File: <span id="currentFileName"></span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNameBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN Entry Modal -->
    <div class="modal fade" id="pinModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Access</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Enter admin PIN to access administrative features:</p>
                    <div class="mb-3">
                        <label for="adminPin" class="form-label">PIN</label>
                        <input type="password" class="form-control" id="adminPin" placeholder="Enter PIN" maxlength="4">
                    </div>
                    <div id="pinError" class="text-danger" style="display: none;">Incorrect PIN</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="verifyPinBtn">Enter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal fade" id="adminPanelModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Panel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>Sale Management</h6>
                        <div id="adminSalesList">
                            <!-- Sales will be populated here -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Column Management</h6>
                        <p class="text-muted small">Delete a column from the current sale. This will affect all users.</p>
                        <div class="row">
                            <div class="col-md-8">
                                <select class="form-select" id="deleteColumnSelect">
                                    <option value="">Select a column to delete...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-danger" id="deleteColumnBtn" disabled>Delete Column</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Data Backup & Restore</h6>
                        <p class="text-muted small">Restore previous versions of sale data (auto-saved every 30 min when changes occur).</p>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-warning" id="manageBackupsBtn">
                                <i class="fas fa-history"></i> Manage Backups
                            </button>
                            <button type="button" class="btn btn-info" id="exportBackupBtn">
                                <i class="fas fa-download"></i> Export Backup
                            </button>
                            <button type="button" class="btn btn-success" id="importBackupBtn">
                                <i class="fas fa-upload"></i> Import Backup
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Edit Control</h6>
                        <p class="text-muted small">Force edit access by kicking out all current editors (emergency override).</p>
                        <button type="button" class="btn btn-danger" id="adminForceEditBtn">
                            <i class="fas fa-user-times"></i> Force Edit (Kick All Users)
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="exitAdminBtn">Exit Admin Mode</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>




    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Copy Sale Modal -->
    <div class="modal fade" id="copySaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Copy Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newSaleName" class="form-label">New Sale Name</label>
                        <input type="text" class="form-control" id="newSaleName" placeholder="Enter name for the copied sale">
                        <div class="form-text">This will create a complete copy of the selected sale with all data.</div>
                    </div>
                    <div class="mb-3">
                        <label for="newSaleDate" class="form-label">Sale Date (Optional)</label>
                        <input type="date" class="form-control" id="newSaleDate">
                    </div>
                    <div class="mb-3">
                        <label for="newSaleLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="newSaleLocation" placeholder="Sale location">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCopySale">Copy Sale</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Backup Management Modal -->
    <div class="modal fade" id="backupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background-color: black; border: 1px solid #333;">
                <div class="modal-header" style="background-color: black; border-bottom: 1px solid #333;">
                    <h5 class="modal-title" style="color: #00cc33; font-family: 'IBM Plex Mono', 'Courier New', monospace; font-weight: bold; letter-spacing: 1px;">
                        FailureSystem FailureSystem FailureSystem FailureSystem
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="background-color: black; color: #00cc33;">
                    <div class="mb-3">
                        <h6 style="color: #00cc33; font-family: 'IBM Plex Mono', 'Courier New', monospace;">Select Sale:</h6>
                        <select class="form-select" id="backupSaleSelect" style="background-color: #222; color: #00cc33; border: 1px solid #00cc33;">
                            <option value="" style="background-color: #222; color: #00cc33;">Choose a sale...</option>
                        </select>
                    </div>
                    <div id="backupsList" style="display: none;">
                        <h6 style="color: #00cc33; font-family: 'IBM Plex Mono', 'Courier New', monospace;">Available Auto Backups (30-min intervals):</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped" style="color: #00cc33; background-color: black;">
                                <thead>
                                    <tr style="background-color: black;">
                                        <th style="color: #00cc33; background-color: black; border-color: #333; font-family: 'IBM Plex Mono', 'Courier New', monospace;">Time</th>
                                        <th style="color: #00cc33; background-color: black; border-color: #333; font-family: 'IBM Plex Mono', 'Courier New', monospace;">Time Ago</th>
                                        <th style="color: #00cc33; background-color: black; border-color: #333; font-family: 'IBM Plex Mono', 'Courier New', monospace;">Changes</th>
                                        <th style="color: #00cc33; background-color: black; border-color: #333; font-family: 'IBM Plex Mono', 'Courier New', monospace;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="backupsTableBody">
                                    <!-- Backup rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="noBackupsMsg" style="display: none;">
                        <div class="alert" style="background-color: #333; border: 1px solid #00cc33; color: #00cc33;">
                            <i class="fas fa-info-circle"></i> No backups available yet. Backups are created automatically every 30 minutes when there are changes.
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color: black; border-top: 1px solid #333;">
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background-color: #333; color: #00cc33; border: 1px solid #00cc33;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ShortlistCombiner {
            constructor() {
                this.files = [];
                this.combinedData = [];
                this.table = null;
                this.customColumns = [];
                this.pendingFile = null; // For storing file while waiting for name
                this.columnOrder = []; // Track column order
                this.hiddenColumns = new Set(); // Track hidden columns
                this.sortState = { column: null, direction: 'asc' }; // Track sort state
                this.filters = {}; // Track column filters
                
                // Edit lock system
                this.isEditMode = false;
                this.editLockTimeout = null;
                this.lastActivity = Date.now();
                this.currentSaleId = null;
                this.userId = this.generateUserId();
                
                this.setupEditMode();
                this.filtersVisible = false; // Track filter row visibility
                this.salesData = new Map(); // Store all sale days data
                this.viewRefreshInterval = null; // Auto-refresh for view mode
                this.deletedHorses = []; // Track deleted horses by hip number
                
                // Admin functionality
                this.isAdmin = false;
                this.adminSessionTimeout = null;
                this.ADMIN_PIN = '42';
                this.ADMIN_TIMEOUT = 30 * 60 * 1000; // 30 minutes
                
                // User-specific column preferences
                this.userId = this.getUserId();
                
                // Undo system - completely isolated from other functions
                this.undoStack = [];
                this.maxUndoLevels = 10;
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadSalesData();
                await this.loadFromURL();
                this.updateSaleSelector();
                
                // Restore last selected sale after refresh
                const savedSaleId = localStorage.getItem('currentSaleId');
                console.log('Trying to restore sale:', savedSaleId);
                console.log('Available sales:', Array.from(this.salesData.keys()));
                
                if (savedSaleId && this.salesData.has(savedSaleId)) {
                    console.log('Restoring sale:', savedSaleId);
                    // Set the dropdown first
                    const selector = document.getElementById('saleSelector');
                    if (selector) {
                        selector.value = savedSaleId;
                        // Then trigger the switch
                        await this.switchSale();
                    }
                } else if (savedSaleId) {
                    console.log('Saved sale no longer exists, clearing');
                    localStorage.removeItem('currentSaleId');
                }
                
                this.addAdminButton(); // Add the LOST numbers button
                this.updateAdminButtonVisibility(); // Set initial button visibility
                this.fixiPadTable(); // Fix iPad table layout
            }

            // Generate or retrieve unique user ID for browser
            getUserId() {
                let userId = localStorage.getItem('repole_user_id');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('repole_user_id', userId);
                }
                return userId;
            }

            // Save user-specific column preferences
            saveUserColumnPreferences() {
                const preferences = {
                    hiddenColumns: Array.from(this.hiddenColumns),
                    columnOrder: this.columnOrder,
                    filtersVisible: this.filtersVisible
                };
                localStorage.setItem(`repole_columns_${this.userId}`, JSON.stringify(preferences));
            }

            // Load user-specific column preferences
            loadUserColumnPreferences() {
                try {
                    const saved = localStorage.getItem(`repole_columns_${this.userId}`);
                    if (saved) {
                        const preferences = JSON.parse(saved);
                        this.hiddenColumns = new Set(preferences.hiddenColumns || []);
                        this.columnOrder = preferences.columnOrder || [];
                        this.filtersVisible = preferences.filtersVisible || false;
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading user column preferences:', error);
                }
                return false;
            }

            setupEventListeners() {
                const fileInput = document.getElementById('fileInput');

                // Upload button
                const uploadBtn = document.getElementById('uploadBtn');
                uploadBtn.addEventListener('click', () => fileInput.click());

                // File input
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });

                // Buttons
                document.getElementById('combineBtn').addEventListener('click', async () => await this.combineData());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                document.getElementById('exportCsvBtn').addEventListener('click', () => this.exportCSV());
                document.getElementById('printTableBtn').addEventListener('click', () => this.printTable());
                document.getElementById('addColumnBtn').addEventListener('click', () => this.showAddColumnModal());
                document.getElementById('saveColumnBtn').addEventListener('click', () => this.addCustomColumn());
                document.getElementById('saveNameBtn').addEventListener('click', () => this.saveShortlistName());
                document.getElementById('addHorseBtn').addEventListener('click', () => this.addNewHorse());
                
                // Admin functionality
                document.getElementById('verifyPinBtn').addEventListener('click', () => this.verifyPin());
                document.getElementById('exitAdminBtn').addEventListener('click', () => this.exitAdminMode());
                document.getElementById('adminPin').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.verifyPin();
                    }
                });
                
                // Admin column deletion
                document.getElementById('deleteColumnSelect').addEventListener('change', (e) => {
                    const deleteBtn = document.getElementById('deleteColumnBtn');
                    deleteBtn.disabled = !e.target.value;
                });
                document.getElementById('deleteColumnBtn').addEventListener('click', () => this.deleteColumnAsAdmin());
                document.getElementById('adminForceEditBtn').addEventListener('click', () => this.adminForceEdit());
                
                // Backup management
                document.getElementById('manageBackupsBtn').addEventListener('click', () => this.showBackupModal());
                document.getElementById('exportBackupBtn').addEventListener('click', () => this.exportBackup());
                document.getElementById('importBackupBtn').addEventListener('click', () => this.importBackup());
                
                // Multi-day event listeners
                document.getElementById('newSaleBtn').addEventListener('click', () => this.showNewSaleModal());
                document.getElementById('createSaleBtn').addEventListener('click', () => this.createNewSale());
                document.getElementById('confirmCopySale').addEventListener('click', () => this.copySale());
                document.getElementById('saleSelector').addEventListener('change', () => this.switchSale());
                document.getElementById('saveSaleChangesBtn').addEventListener('click', () => this.saveSaleChanges());
                
                
                // Column control event listeners
                document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAllColumns());
                document.getElementById('resetColumnsBtn').addEventListener('click', () => this.resetColumnLayout());
                document.getElementById('toggleFiltersBtn').addEventListener('click', () => this.toggleFilters());
                document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearAllFilters());
                document.getElementById('undoBtn').addEventListener('click', () => this.performUndo());
                document.getElementById('moveLeftBtn').addEventListener('click', () => this.moveColumn('left'));
                document.getElementById('moveRightBtn').addEventListener('click', () => this.moveColumn('right'));

                // Column type change
                document.getElementById('columnType').addEventListener('change', (e) => {
                    document.getElementById('selectOptions').style.display = 
                        e.target.value === 'select' ? 'block' : 'none';
                });

                // Enter key support for name modal
                document.getElementById('shortlistOwner').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.saveShortlistName();
                    }
                });

                // Add admin button to page (hidden by default)
                this.addAdminButton();
            }

            // ========== MULTI-DAY STORAGE METHODS ==========
            // Designed to be easily swappable with Upstash Redis API calls

            async loadSalesData() {
                try {
                    const response = await fetch('https://solis-litt-sales.vercel.app/api/sales');
                    const result = await response.json();
                    
                    if (response.ok && result.sales) {
                        this.salesData = new Map(Object.entries(result.sales));
                        // Clean any legacy column preference data (but keep actual data intact)
                        for (const [saleId, saleInfo] of this.salesData.entries()) {
                            if (saleInfo.data) {
                                // Only delete column preferences, keep all actual data
                                delete saleInfo.data.columnOrder;
                                delete saleInfo.data.hiddenColumns;
                                delete saleInfo.data.filtersVisible;
                                // Keep: files, combinedData, customColumns, sortState, filters
                            }
                        }
                    } else {
                        this.salesData = new Map();
                    }
                } catch (error) {
                    console.error('Error loading sales data:', error);
                    this.salesData = new Map();
                }
            }

            async saveSalesData() {
                try {
                    for (const [saleId, saleData] of this.salesData.entries()) {
                        await fetch('https://solis-litt-sales.vercel.app/api/sales', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                saleId: saleId,
                                saleData: saleData
                            })
                        });
                    }
                    console.log('Sales data saved to Redis');
                } catch (error) {
                    console.error('Error saving sales data:', error);
                }
            }

            async saveSaleDay(saleId) {
                if (!saleId || !this.salesData.has(saleId)) return;

                // Record that data has changed
                this.recordDataChange(saleId);
                
                // Create backup if needed (30min + changes)
                this.createHourlyBackupIfNeeded(saleId);

                const saleData = {
                    files: this.files,
                    combinedData: this.combinedData, // Keep data sharing across users
                    customColumns: this.customColumns, // Keep custom columns global
                    // Column preferences (order, hidden, filters visible) are user-specific
                    sortState: this.sortState, // Keep sort state global
                    filters: this.filters, // Keep filters global
                    deletedHorses: this.deletedHorses, // Keep deleted horses list global
                    lastUpdated: new Date().toISOString()
                };

                // Update the sale's data
                const saleInfo = this.salesData.get(saleId);
                saleInfo.data = saleData;
                this.salesData.set(saleId, saleInfo);

                await this.saveSalesData();
            }

            async loadSaleDay(saleId) {
                if (!saleId || !this.salesData.has(saleId)) return false;

                const saleInfo = this.salesData.get(saleId);
                const saleData = saleInfo.data;

                if (!saleData) return false;

                // Load sale day data
                this.files = saleData.files || [];
                this.combinedData = saleData.combinedData || [];
                this.customColumns = saleData.customColumns || [];
                this.deletedHorses = saleData.deletedHorses || [];
                
                // Migrate Pinhook column to Notes for existing sales
                this.combinedData.forEach(row => {
                    if (row.hasOwnProperty('Pinhook')) {
                        row.Notes = row.Pinhook;
                        delete row.Pinhook;
                    }
                });
                
                // Migrate column order as well
                if (saleData.sortState && saleData.sortState.column === 'Pinhook') {
                    saleData.sortState.column = 'Notes';
                }
                if (saleData.filters && saleData.filters.Pinhook) {
                    saleData.filters.Notes = saleData.filters.Pinhook;
                    delete saleData.filters.Pinhook;
                }
                
                // Apply globally deleted columns
                const deletedColumns = saleInfo.deletedColumns || [];
                if (deletedColumns.length > 0) {
                    // Remove deleted columns from data
                    this.combinedData.forEach(row => {
                        deletedColumns.forEach(col => delete row[col]);
                    });
                    
                    // Remove from files array
                    this.files = this.files.filter(file => !deletedColumns.includes(file.name));
                    
                    // Remove from custom columns
                    this.customColumns = this.customColumns.filter(col => !deletedColumns.includes(col));
                }
                
                // Only load user-specific column preferences if sale has data with columns
                if (this.combinedData.length > 0 && this.files.length > 0) {
                    if (!this.loadUserColumnPreferences()) {
                        // If no user preferences, set defaults (don't use sale data)
                        this.columnOrder = [];
                        this.hiddenColumns = new Set();
                        this.filtersVisible = false;
                    }
                } else {
                    // For new/empty sales, start with clean slate
                    this.columnOrder = [];
                    this.hiddenColumns = new Set();
                    this.filtersVisible = false;
                }
                
                this.sortState = saleData.sortState || { column: null, direction: 'asc' };
                this.filters = saleData.filters || {};

                // Also load files from persistent storage for this sale
                await this.loadPersistentFilesForSale(saleId);

                return true;
            }

            async loadPersistentFilesForSale(saleId) {
                // Files are stored in localStorage as part of the sale data
                // No separate API call needed for GitHub Pages deployment
                console.log(`Files for sale ${saleId} loaded from localStorage`);
            }

            generateSaleId(saleName, saleDate) {
                // Create a unique ID from name and date
                const cleanName = saleName.toLowerCase().replace(/[^a-z0-9]/g, '_');
                return `${saleDate}_${cleanName}`;
            }

            updateSaleSelector() {
                const selector = document.getElementById('saleSelector');
                selector.innerHTML = '<option value="">Select a sale day...</option>';

                // Sort sales by date (newest first)
                const sortedSales = Array.from(this.salesData.entries()).sort((a, b) => {
                    return new Date(b[1].saleDate) - new Date(a[1].saleDate);
                });

                sortedSales.forEach(([saleId, saleInfo]) => {
                    const option = document.createElement('option');
                    option.value = saleId;
                    // Fix timezone issue by parsing date as local date
                    const localDate = new Date(saleInfo.saleDate + 'T00:00:00');
                    option.textContent = `${saleInfo.saleName} (${localDate.toLocaleDateString()})`;
                    if (saleId === this.currentSaleId) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            }

            updateCurrentSaleInfo() {
                const infoDiv = document.getElementById('currentSaleInfo');
                if (!this.currentSaleId || !this.salesData.has(this.currentSaleId)) {
                    infoDiv.innerHTML = '<small class="text-muted">No sale selected</small>';
                    return;
                }

                const saleInfo = this.salesData.get(this.currentSaleId);
                const lastUpdated = saleInfo.data?.lastUpdated ? 
                    new Date(saleInfo.data.lastUpdated).toLocaleString() : 'Never';

                // Fix timezone issue by parsing date as local date
                const localDate = new Date(saleInfo.saleDate + 'T00:00:00');
                infoDiv.innerHTML = `
                    <div>
                        <strong>${saleInfo.saleName}</strong> - ${localDate.toLocaleDateString()}
                        ${saleInfo.location ? `<br><small class="text-muted">${saleInfo.location}</small>` : ''}
                    </div>
                `;
            }

            showNewSaleModal() {
                const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
                // Set default date to today
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                modal.show();
            }

            async createNewSale() {
                const saleName = document.getElementById('saleName').value.trim();
                const saleDate = document.getElementById('saleDate').value;
                const location = document.getElementById('saleLocation').value.trim();
                const hipUrlTemplate = document.getElementById('hipUrlTemplate').value.trim();
                const saleDataFile = document.getElementById('saleDataFile').files[0];

                if (!saleName || !saleDate) {
                    alert('Please enter a sale name and date');
                    return;
                }

                // Validate URL template if provided
                if (hipUrlTemplate && !this.validateHipUrlTemplate(hipUrlTemplate)) {
                    alert('Please enter a valid URL for Hip 1. Example: http://apps.keeneland.com/sales/k224/pdfs/1.pdf');
                    return;
                }

                const saleId = this.generateSaleId(saleName, saleDate);
                
                if (this.salesData.has(saleId)) {
                    alert('A sale with this name and date already exists');
                    return;
                }

                // Create new sale
                const saleInfo = {
                    saleId,
                    saleName,
                    saleDate,
                    location,
                    hipUrlTemplate: hipUrlTemplate || null, // Store the URL template for generating hip links
                    created: new Date().toISOString(),
                    data: null // Will be populated when first saved
                };

                this.salesData.set(saleId, saleInfo);
                await this.saveSalesData();

                // Switch to new sale
                this.currentSaleId = saleId;
                this.resetForNewSale();
                this.updateSaleSelector();
                this.updateCurrentSaleInfo();
                this.showWorkingSections();

                // If a file was selected, import it
                if (saleDataFile) {
                    this.importSaleDataFile(saleDataFile);
                }

                // Close modal and clear form
                bootstrap.Modal.getInstance(document.getElementById('newSaleModal')).hide();
                
                // Clear form fields
                document.getElementById('saleName').value = '';
                document.getElementById('saleDate').value = '';
                document.getElementById('saleLocation').value = '';
                document.getElementById('hipUrlTemplate').value = '';
                document.getElementById('saleDataFile').value = '';
            }

            importSaleDataFile(file) {
                const isCSV = file.type === 'text/csv' || file.name.endsWith('.csv');
                const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || 
                               file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                               file.type === 'application/vnd.ms-excel';

                if (isCSV) {
                    this.importCSVFile(file);
                } else if (isExcel) {
                    this.importExcelFile(file);
                } else {
                    alert('Please select a CSV or Excel file.');
                }
            }

            importCSVFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim(),
                            complete: (results) => {
                                if (results.errors.length > 0) {
                                    console.warn('CSV parsing warnings:', results.errors);
                                }
                                
                                // Set the data directly as combinedData - display exactly as-is
                                this.combinedData = results.data.filter(row => {
                                    // Filter out completely empty rows
                                    return Object.values(row).some(value => 
                                        value && value.toString().trim() !== ''
                                    );
                                });
                                
                                // Reset column order so it uses the imported data columns
                                this.columnOrder = [];
                                
                                // Create and display the table
                                this.createTable();
                                this.updateStats();
                                this.showResults();
                                this.autoSave();
                                
                                console.log(`Imported ${this.combinedData.length} rows from CSV file`);
                            }
                        });
                    } catch (error) {
                        console.error('Error parsing CSV:', error);
                        alert('Error reading CSV file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }

            importExcelFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: ''
                        });

                        if (jsonData.length < 2) {
                            alert('The Excel file appears to be empty or has no data rows.');
                            return;
                        }

                        // Convert to object format with headers
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1);
                        
                        this.combinedData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header.toString().trim()] = row[index] || '';
                            });
                            return obj;
                        }).filter(row => {
                            // Filter out completely empty rows
                            return Object.values(row).some(value => 
                                value && value.toString().trim() !== ''
                            );
                        });

                        // Reset column order so it uses the imported data columns
                        this.columnOrder = [];

                        // Create and display the table
                        this.createTable();
                        this.updateStats();
                        this.showResults();
                        this.autoSave();
                        
                        console.log(`Imported ${this.combinedData.length} rows from Excel file`);
                    } catch (error) {
                        console.error('Error parsing Excel file:', error);
                        alert('Error reading Excel file. Please check the file format.');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            validateHipUrlTemplate(url) {
                try {
                    new URL(url); // Basic URL validation
                    
                    // Check for various hip 1 URL patterns
                    const patterns = [
                        /1\.pdf$/i,  // Original: 1.pdf
                        /\/1\/?$/,   // Tattersalls & Goffs: ends with /1 or /1/
                    ];
                    
                    return patterns.some(pattern => pattern.test(url));
                } catch (e) {
                    return false;
                }
            }

            generateHipUrl(hipNumber, saleInfo) {
                if (!saleInfo?.hipUrlTemplate || !hipNumber) {
                    return null;
                }
                
                try {
                    // Clean hip number (remove any non-numeric characters)
                    const cleanHipNumber = hipNumber.toString().replace(/[^0-9]/g, '');
                    if (!cleanHipNumber) {
                        return null;
                    }
                    
                    let url = saleInfo.hipUrlTemplate;
                    
                    // Handle different URL patterns
                    if (url.match(/1\.pdf$/i)) {
                        // PDF pattern: replace "1.pdf" with "{hipNumber}.pdf"
                        url = url.replace(/1\.pdf$/i, `${cleanHipNumber}.pdf`);
                    } else if (url.match(/\/1\/?$/)) {
                        // Path pattern: replace "/1" or "/1/" with "/{hipNumber}"
                        url = url.replace(/\/1\/?$/, `/${cleanHipNumber}`);
                    }
                    
                    // Validate the generated URL
                    new URL(url);
                    return url;
                } catch (e) {
                    console.warn(`Invalid URL generated for hip ${hipNumber}:`, e);
                    return null;
                }
            }

            async switchSale() {
                const selector = document.getElementById('saleSelector');
                const selectedSaleId = selector.value;

                if (!selectedSaleId) {
                    this.currentSaleId = null;
                    localStorage.removeItem('currentSaleId'); // Clear saved sale
                    this.hideWorkingSections();
                    this.updateCurrentSaleInfo();
                    return;
                }

                // Save current sale if exists
                if (this.currentSaleId) {
                    await this.saveSaleDay(this.currentSaleId);
                }

                // Load selected sale
                this.currentSaleId = selectedSaleId;
                
                // Exit edit mode when switching sales
                if (this.isEditMode) {
                    await this.exitEditMode();
                }
                
                // Clear undo stack when switching sales - keeps it clean and prevents confusion
                this.clearUndoStack();
                
                // Save current sale to localStorage for refresh persistence
                localStorage.setItem('currentSaleId', selectedSaleId);
                
                const loaded = await this.loadSaleDay(selectedSaleId);

                if (loaded) {
                    this.updateFileList();
                    this.updateCombineButton();
                    if (this.combinedData.length > 0) {
                        // If this sale hasn't been manually sorted yet, sort by hip number
                        if (!this.sortState.column || this.sortState.column === 'Overlap') {
                            this.combinedData.sort((a, b) => {
                                const hipA = a.Hip || '';
                                const hipB = b.Hip || '';
                                
                                // Handle 'NEW' entries - put them at the end
                                if (hipA === 'NEW' && hipB !== 'NEW') return 1;
                                if (hipB === 'NEW' && hipA !== 'NEW') return -1;
                                if (hipA === 'NEW' && hipB === 'NEW') return 0;
                                
                                // Convert to numbers for proper numeric sorting
                                const numA = parseInt(hipA) || 0;
                                const numB = parseInt(hipB) || 0;
                                
                                return numA - numB;
                            });
                            this.sortState = { column: 'Hip', direction: 'asc' };
                        }
                        this.createTable();
                        this.updateStats();
                        this.showResults();
                    }
                } else {
                    this.resetForNewSale();
                }

                this.updateCurrentSaleInfo();
                this.showWorkingSections();
                
                // Start auto-refresh if in view mode
                if (!this.isEditMode && this.currentSaleId) {
                    this.startViewRefresh();
                }
            }

            resetForNewSale() {
                // Reset all state for a new sale
                this.files = [];
                this.combinedData = [];
                this.customColumns = [];
                this.columnOrder = [];
                this.hiddenColumns = new Set();
                this.sortState = { column: null, direction: 'asc' };
                this.filters = {};
                this.filtersVisible = false;
                this.deletedHorses = [];
                
                // Clear user column preferences for new sale to avoid old column artifacts
                this.saveUserColumnPreferences();

                // Clear UI
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
                if (this.table) {
                    this.table.destroy();
                    this.table = null;
                }
                document.querySelector('#mainTable thead').innerHTML = '';
                document.querySelector('#mainTable tbody').innerHTML = '';
                this.updateCombineButton();
            }

            showEditSalesModal() {
                this.populateEditSalesModal();
                const modal = new bootstrap.Modal(document.getElementById('editSalesModal'));
                modal.show();
            }

            populateEditSalesModal() {
                const salesList = document.getElementById('salesList');
                salesList.innerHTML = '';

                if (this.salesData.size === 0) {
                    salesList.innerHTML = '<p class="text-muted">No sales created yet.</p>';
                    return;
                }

                // Convert Map to Array and sort by date
                const salesArray = Array.from(this.salesData.values()).sort((a, b) => 
                    new Date(a.saleDate) - new Date(b.saleDate)
                );

                salesArray.forEach((sale, index) => {
                    const saleDiv = document.createElement('div');
                    saleDiv.className = 'border rounded p-3 mb-3';
                    saleDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${sale.saleName}</h6>
                                <p class="mb-1 text-muted">${sale.saleDate} ${sale.location ? '• ' + sale.location : ''}</p>
                                <small class="text-muted">Created: ${new Date(sale.created).toLocaleDateString()}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-danger" onclick="combiner.deleteSale('${sale.saleId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    salesList.appendChild(saleDiv);
                });
            }

            renameSale(saleId) {
                if (!this.salesData.has(saleId)) return;

                const sale = this.salesData.get(saleId);
                this.editingSaleId = saleId;

                // Populate the rename modal
                document.getElementById('editSaleName').value = sale.saleName;
                document.getElementById('editSaleDate').value = sale.saleDate;
                document.getElementById('editSaleLocation').value = sale.location || '';

                // Show rename modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editSalesModal'));
                editModal.hide();
                
                const renameModal = new bootstrap.Modal(document.getElementById('renameSaleModal'));
                renameModal.show();
            }

            async saveSaleChanges() {
                if (!this.editingSaleId) return;

                const saleName = document.getElementById('editSaleName').value.trim();
                const saleDate = document.getElementById('editSaleDate').value;
                const location = document.getElementById('editSaleLocation').value.trim();

                if (!saleName || !saleDate) {
                    alert('Please enter a sale name and date');
                    return;
                }

                // Update the sale info
                const sale = this.salesData.get(this.editingSaleId);
                sale.saleName = saleName;
                sale.saleDate = saleDate;
                sale.location = location;

                await this.saveSalesData();
                this.updateSaleSelector();
                this.updateCurrentSaleInfo();

                // Close rename modal and show edit modal again
                bootstrap.Modal.getInstance(document.getElementById('renameSaleModal')).hide();
                this.showEditSalesModal();

                this.editingSaleId = null;
            }


            async deleteSale(saleId) {
                if (!this.salesData.has(saleId)) return;

                const sale = this.salesData.get(saleId);
                if (!confirm(`Are you sure you want to delete "${sale.saleName}"? This action cannot be undone.`)) {
                    return;
                }

                // If deleting current sale, switch to no sale
                if (this.currentSaleId === saleId) {
                    this.currentSaleId = null;
                    this.resetForNewSale();
                    this.hideWorkingSections();
                }

                this.salesData.delete(saleId);
                await this.saveSalesData();
                this.updateSaleSelector();
                this.updateCurrentSaleInfo();
                this.populateEditSalesModal();
            }


            showWorkingSections() {
                document.getElementById('uploadSection').style.display = 'block';
            }

            hideWorkingSections() {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
            }

            // 30-Minute Change-Based Backup System
            createHourlyBackupIfNeeded(saleId) {
                try {
                    const now = Date.now();
                    const thirtyMinutes = 30 * 60 * 1000; // 30 minutes
                    
                    const lastBackupKey = `repole_last_backup_time_${saleId}`;
                    const lastChangeKey = `repole_last_change_time_${saleId}`;
                    
                    const lastBackupTime = parseInt(localStorage.getItem(lastBackupKey) || '0');
                    const lastChangeTime = parseInt(localStorage.getItem(lastChangeKey) || '0');
                    
                    // Only create backup if:
                    // 1. At least 30 minutes have passed since last backup, AND
                    // 2. There have been changes since the last backup
                    if (now - lastBackupTime < thirtyMinutes) {
                        return; // Too soon since last backup
                    }
                    
                    if (lastChangeTime <= lastBackupTime) {
                        return; // No changes since last backup
                    }
                    
                    // Create the backup
                    this.createHourlyBackup(saleId, now);
                    
                    // Update the last backup time
                    localStorage.setItem(lastBackupKey, now.toString());
                    
                } catch (error) {
                    console.error('Error checking backup:', error);
                }
            }
            
            // Track when data changes occur
            recordDataChange(saleId) {
                try {
                    const lastChangeKey = `repole_last_change_time_${saleId}`;
                    localStorage.setItem(lastChangeKey, Date.now().toString());
                } catch (error) {
                    console.error('Error recording data change:', error);
                }
            }

            createHourlyBackup(saleId, timestamp) {
                try {
                    const saleData = this.salesData.get(saleId);
                    if (!saleData) return;

                    const backupKey = `repole_hourly_backups_${saleId}`;
                    const existingBackups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    
                    // Create backup entry
                    const backup = {
                        timestamp: timestamp,
                        data: JSON.parse(JSON.stringify(saleData)) // Deep copy
                    };
                    
                    // Add to beginning (newest first)
                    existingBackups.unshift(backup);
                    
                    // Keep only last 10 backups
                    if (existingBackups.length > 10) {
                        existingBackups.splice(10);
                    }
                    
                    // Save updated backups
                    localStorage.setItem(backupKey, JSON.stringify(existingBackups));
                    
                } catch (error) {
                    console.error('Error creating backup:', error);
                }
            }

            showBackupModal() {
                if (!this.isAdmin) return;
                
                // Populate sales dropdown
                const salesSelect = document.getElementById('backupSaleSelect');
                salesSelect.innerHTML = '<option value="">Choose a sale...</option>';
                
                this.salesData.forEach((sale, saleId) => {
                    const option = document.createElement('option');
                    option.value = saleId;
                    option.textContent = `${sale.saleName} - ${sale.saleDate}`;
                    option.style.backgroundColor = '#222';
                    option.style.color = '#00cc33';
                    salesSelect.appendChild(option);
                });
                
                // Add change event listener
                salesSelect.onchange = () => this.loadBackupsForSale();
                
                // Show modal
                new bootstrap.Modal(document.getElementById('backupModal')).show();
            }

            loadBackupsForSale() {
                const salesSelect = document.getElementById('backupSaleSelect');
                const selectedSaleId = salesSelect.value;
                
                const backupsList = document.getElementById('backupsList');
                const noBackupsMsg = document.getElementById('noBackupsMsg');
                const tableBody = document.getElementById('backupsTableBody');
                
                if (!selectedSaleId) {
                    backupsList.style.display = 'none';
                    noBackupsMsg.style.display = 'none';
                    return;
                }
                
                try {
                    const backupKey = `repole_hourly_backups_${selectedSaleId}`;
                    const backups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    
                    if (backups.length === 0) {
                        backupsList.style.display = 'none';
                        noBackupsMsg.style.display = 'block';
                        return;
                    }
                    
                    // Populate table
                    tableBody.innerHTML = '';
                    backups.forEach((backup, index) => {
                        const backupDate = new Date(backup.timestamp);
                        const minutesAgo = Math.floor((Date.now() - backup.timestamp) / (1000 * 60));
                        const timeAgo = minutesAgo < 60 ? `${minutesAgo} min ago` : `${Math.floor(minutesAgo / 60)}h ${minutesAgo % 60}m ago`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="background-color: black; color: #00cc33; border-color: #333;">${backupDate.toLocaleString()}</td>
                            <td style="background-color: black; color: #00cc33; border-color: #333;">${timeAgo}</td>
                            <td style="background-color: black; color: #00cc33; border-color: #333;">Auto backup</td>
                            <td style="background-color: black; color: #00cc33; border-color: #333;">
                                <button class="btn btn-sm me-1" onclick="combiner.restoreBackup('${selectedSaleId}', ${index})" style="background-color: #333; color: #00cc33; border: 1px solid #00cc33;">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                                <button class="btn btn-sm" onclick="combiner.exportSpecificBackup('${selectedSaleId}', ${index})" style="background-color: #333; color: #00cc33; border: 1px solid #00cc33;">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    backupsList.style.display = 'block';
                    noBackupsMsg.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error loading backups:', error);
                    backupsList.style.display = 'none';
                    noBackupsMsg.style.display = 'block';
                }
            }

            async restoreBackup(saleId, backupIndex) {
                if (!this.isAdmin) return;
                
                if (!confirm('Are you sure you want to restore this backup? This will replace all current data for this sale.')) {
                    return;
                }
                
                try {
                    const backupKey = `repole_hourly_backups_${saleId}`;
                    const backups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    
                    if (!backups[backupIndex]) {
                        alert('Backup not found.');
                        return;
                    }
                    
                    // Restore the backup data
                    const backupData = backups[backupIndex].data;
                    this.salesData.set(saleId, backupData);
                    
                    // Save restored data
                    await this.saveSalesData();
                    
                    // If this is the current sale, refresh display
                    if (this.currentSaleId === saleId) {
                        const saleData = backupData.data;
                        this.combinedData = [...(saleData.combinedData || [])];
                        this.columnOrder = [...(saleData.columnOrder || [])];
                        this.customColumns = [...(saleData.customColumns || [])];
                        this.files = [...(saleData.files || [])];
                        
                        this.updateFileList();
                        console.log('About to call createTable()');
                        this.createTable();
                        console.log('About to call updateStats()');
                        this.updateStats();
                        console.log('Table refresh completed');
                    }
                    
                    alert('Backup restored successfully!');
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
                    
                } catch (error) {
                    console.error('Error restoring backup:', error);
                    alert('Error restoring backup. Please try again.');
                }
            }

            // Export specific backup from backup management
            exportSpecificBackup(saleId, backupIndex) {
                if (!this.isAdmin) return;
                
                try {
                    const backupKey = `repole_hourly_backups_${saleId}`;
                    const backups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    
                    if (!backups[backupIndex]) {
                        alert('Backup not found.');
                        return;
                    }
                    
                    const backup = backups[backupIndex];
                    const saleData = backup.data;
                    
                    // Create export data
                    const exportData = {
                        saleName: saleData.saleName,
                        saleDate: saleData.saleDate,
                        location: saleData.location,
                        hipUrlTemplate: saleData.hipUrlTemplate,
                        exportTime: new Date().toISOString(),
                        backupTime: new Date(backup.timestamp).toISOString(),
                        exportedBy: 'Admin',
                        exportType: 'Historical Backup',
                        data: JSON.parse(JSON.stringify(saleData.data)) // Deep copy
                    };
                    
                    // Create filename with backup timestamp
                    const backupDate = new Date(backup.timestamp);
                    const dateStr = backupDate.toISOString().split('T')[0]; // YYYY-MM-DD
                    const timeStr = backupDate.toTimeString().substring(0, 8).replace(/:/g, '-'); // HH-MM-SS
                    const safeSaleName = saleData.saleName.replace(/[^a-z0-9]/gi, '_');
                    const filename = `${safeSaleName}_backup_${dateStr}_${timeStr}.json`;
                    
                    // Create and download file
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    alert(`Historical backup exported as: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting specific backup:', error);
                    alert('Error exporting backup. Please try again.');
                }
            }

            // Export/Import Backup Functionality
            exportBackup() {
                if (!this.isAdmin) return;
                
                if (!this.currentSaleId) {
                    alert('Please select a sale first.');
                    return;
                }
                
                try {
                    const saleData = this.salesData.get(this.currentSaleId);
                    if (!saleData) {
                        alert('No sale data found.');
                        return;
                    }
                    
                    // Create export data
                    const exportData = {
                        saleName: saleData.saleName,
                        saleDate: saleData.saleDate,
                        location: saleData.location,
                        hipUrlTemplate: saleData.hipUrlTemplate,
                        exportTime: new Date().toISOString(),
                        exportedBy: 'Admin',
                        data: JSON.parse(JSON.stringify(saleData.data)) // Deep copy
                    };
                    
                    // Create filename
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T');
                    const dateStr = timestamp[0]; // YYYY-MM-DD
                    const timeStr = timestamp[1].substring(0, 8); // HH-MM-SS
                    const safeSaleName = saleData.saleName.replace(/[^a-z0-9]/gi, '_');
                    const filename = `${safeSaleName}_backup_${dateStr}_${timeStr}.json`;
                    
                    // Create and download file
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    alert(`Backup exported as: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting backup:', error);
                    alert('Error exporting backup. Please try again.');
                }
            }

            importBackup() {
                if (!this.isAdmin) return;
                
                if (!confirm('Importing a backup will replace ALL current data for that sale. Are you sure?')) {
                    return;
                }
                
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const text = await file.text();
                        const importData = JSON.parse(text);
                        
                        // Validate import data
                        if (!importData.saleName || !importData.data) {
                            alert('Invalid backup file format.');
                            return;
                        }
                        
                        // Generate new sale ID or find existing
                        let saleId = null;
                        for (const [id, sale] of this.salesData.entries()) {
                            if (sale.saleName === importData.saleName && sale.saleDate === importData.saleDate) {
                                saleId = id;
                                break;
                            }
                        }
                        
                        // If sale doesn't exist, create new one
                        if (!saleId) {
                            saleId = Date.now().toString();
                        }
                        
                        // Restore the data
                        const restoredSale = {
                            saleName: importData.saleName,
                            saleDate: importData.saleDate,
                            location: importData.location || '',
                            hipUrlTemplate: importData.hipUrlTemplate || '',
                            data: importData.data
                        };
                        
                        this.salesData.set(saleId, restoredSale);
                        
                        // Save to cloud
                        await this.saveSalesData();
                        
                        // Update UI
                        this.updateSaleSelector();
                        
                        // If this matches current sale, refresh display
                        if (this.currentSaleId === saleId) {
                            const saleData = restoredSale.data;
                            this.combinedData = [...(saleData.combinedData || [])];
                            this.columnOrder = [...(saleData.columnOrder || [])];
                            this.customColumns = [...(saleData.customColumns || [])];
                            this.files = [...(saleData.files || [])];
                            
                            this.updateFileList();
                            this.createTable();
                            this.updateStats();
                        }
                        
                        alert(`Backup imported successfully: ${importData.saleName}`);
                        
                    } catch (error) {
                        console.error('Error importing backup:', error);
                        alert('Error importing backup. Please check the file format.');
                    }
                };
                
                // Trigger file selection
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            // UNDO SYSTEM - Completely isolated, won't affect other functions
            saveUndoState(actionType, actionData) {
                try {
                    // Only save if we have data to save
                    if (!this.combinedData || this.combinedData.length === 0) {
                        return;
                    }
                    
                    // Create deep copy of current state - completely separate from other systems
                    const undoState = {
                        timestamp: Date.now(),
                        actionType: actionType, // 'edit', 'delete', 'add'
                        actionData: actionData,
                        combinedData: JSON.parse(JSON.stringify(this.combinedData)),
                        customColumns: JSON.parse(JSON.stringify(this.customColumns || []))
                    };
                    
                    // Add to undo stack
                    this.undoStack.push(undoState);
                    
                    // Keep only last 10 actions to prevent memory issues
                    if (this.undoStack.length > this.maxUndoLevels) {
                        this.undoStack.shift();
                    }
                    
                    // Update undo button state
                    this.updateUndoButton();
                    
                } catch (error) {
                    console.error('Error saving undo state:', error);
                    // Silently fail - won't affect other functionality
                }
            }
            
            updateUndoButton() {
                try {
                    const undoBtn = document.getElementById('undoBtn');
                    if (!undoBtn) return;
                    
                    if (this.undoStack.length > 0) {
                        const lastAction = this.undoStack[this.undoStack.length - 1];
                        undoBtn.disabled = false;
                        undoBtn.title = `Undo: ${this.getActionDescription(lastAction)}`;
                    } else {
                        undoBtn.disabled = true;
                        undoBtn.title = 'Nothing to undo';
                    }
                } catch (error) {
                    console.error('Error updating undo button:', error);
                    // Silently fail - won't affect other functionality
                }
            }
            
            getActionDescription(undoState) {
                try {
                    switch (undoState.actionType) {
                        case 'edit':
                            const editData = undoState.actionData;
                            return `Edit ${editData.column} for Hip ${editData.hip}`;
                        case 'delete':
                            const deleteData = undoState.actionData;
                            return `Delete Hip ${deleteData.hip}`;
                        case 'add':
                            return 'Add new horse';
                        default:
                            return 'Last action';
                    }
                } catch (error) {
                    return 'Last action';
                }
            }
            
            async performUndo() {
                try {
                    if (this.undoStack.length === 0) return;
                    
                    // Get the last saved state
                    const undoState = this.undoStack.pop();
                    
                    // Restore the previous state - completely replace current data
                    this.combinedData = JSON.parse(JSON.stringify(undoState.combinedData));
                    this.customColumns = JSON.parse(JSON.stringify(undoState.customColumns));
                    
                    // Re-render table with restored data using existing method
                    this.createTable();
                    this.updateStats();
                    
                    // Update undo button
                    this.updateUndoButton();
                    
                    // Save the restored state (auto-save will handle this)
                    if (this.currentSaleId) {
                        await this.saveSaleDay(this.currentSaleId);
                    }
                    
                    // Show success message
                    const actionDesc = this.getActionDescription(undoState);
                    console.log(`Undid: ${actionDesc}`);
                    
                } catch (error) {
                    console.error('Error performing undo:', error);
                    alert(`Error performing undo: ${error.message}. Please try again.`);
                }
            }
            
            // Clear undo stack when switching sales - keeps memory clean
            clearUndoStack() {
                this.undoStack = [];
                this.updateUndoButton();
            }

            // Auto-save functionality
            async autoSave() {
                if (this.checkIfSaleFrozen()) {
                    return;
                }
                if (this.currentSaleId) {
                    await this.saveSaleDay(this.currentSaleId);
                }
            }

            handleFiles(fileList) {
                // Provide better feedback for touch devices
                const fileCount = fileList.length;
                if (fileCount > 1) {
                    if (!confirm(`Upload ${fileCount} files?`)) return;
                }
                
                Array.from(fileList).forEach(file => {
                    const isCSV = file.type === 'text/csv' || file.name.endsWith('.csv');
                    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || 
                                   file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                                   file.type === 'application/vnd.ms-excel';
                    
                    if (isCSV || isExcel) {
                        this.processFile(file);
                    } else {
                        alert(`${file.name} is not a supported file type. Please use CSV or Excel files.`);
                    }
                });
            }

            processFile(file) {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                const isCSV = file.type === 'text/csv' || file.name.endsWith('.csv');
                const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || 
                               file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                               file.type === 'application/vnd.ms-excel';

                if (isCSV) {
                    this.processCSVFile(file);
                } else if (isExcel) {
                    this.processExcelFile(file);
                }
            }

            processCSVFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim(),
                            complete: (results) => {
                                if (results.errors.length > 0) {
                                    console.warn('CSV parsing warnings:', results.errors);
                                }
                                
                                const fileData = {
                                    file: file,
                                    fileName: file.name.replace(/\.(csv)$/i, ''),
                                    data: results.data.filter(row => {
                                        // Filter out completely empty rows
                                        return Object.values(row).some(value => 
                                            value && value.toString().trim() !== ''
                                        );
                                    }),
                                    errors: results.errors,
                                    type: 'CSV'
                                };
                                
                                console.log(`Processed ${fileData.fileName}: ${fileData.data.length} rows`);
                                this.checkForNotesColumn(fileData);
                            },
                            error: (error) => {
                                console.error('Error parsing CSV:', error);
                                alert(`Error parsing ${file.name}: ${error.message}`);
                            }
                        });
                    } catch (error) {
                        console.error('Error reading CSV file:', error);
                        alert(`Error reading ${file.name}: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    alert(`Error reading file: ${file.name}`);
                };
                reader.readAsText(file);
            }

            processExcelFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Use the first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON with header row
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        
                        if (jsonData.length === 0) {
                            alert(`${file.name} appears to be empty.`);
                            return;
                        }
                        
                        // Get headers from first row
                        const headers = jsonData[0].map(h => h ? h.toString().trim() : '');
                        const dataRows = jsonData.slice(1);
                        
                        // Convert to object format
                        const processedData = dataRows
                            .filter(row => row.some(cell => cell && cell.toString().trim() !== ''))
                            .map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] ? row[index].toString().trim() : '';
                                });
                                return obj;
                            });
                        
                        const fileData = {
                            file: file,
                            fileName: file.name.replace(/\.(xlsx|xls)$/i, ''),
                            data: processedData,
                            errors: [],
                            type: 'Excel',
                            sheet: firstSheetName
                        };
                        
                        console.log(`Processed ${fileData.fileName}: ${fileData.data.length} rows from sheet "${firstSheetName}"`);
                        this.checkForNotesColumn(fileData);
                        
                    } catch (error) {
                        console.error('Error parsing Excel file:', error);
                        alert(`Error parsing ${file.name}: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    alert(`Error reading file: ${file.name}`);
                };
                reader.readAsArrayBuffer(file);
            }
            
            checkForNotesColumn(fileData) {
                // Check if file has any Notes columns (notes, notes1, notes2, etc.)
                if (!fileData.data || fileData.data.length === 0) {
                    this.askForOwnerName(fileData);
                    return;
                }
                
                const sampleRow = fileData.data[0];
                const columnNames = Object.keys(sampleRow);
                
                // Find Notes columns (case insensitive)
                const notesColumns = columnNames.filter(col => 
                    /^notes\d*$/i.test(col.trim())
                );
                
                if (notesColumns.length === 0) {
                    // No Notes columns found, proceed normally
                    this.askForOwnerName(fileData);
                    return;
                }
                
                // Found Notes columns, ask user what to name them
                this.handleNotesColumns(fileData, notesColumns);
            }
            
            handleNotesColumns(fileData, notesColumns) {
                this.pendingFile = fileData;
                this.pendingNotesColumns = notesColumns;
                this.currentNotesIndex = 0;
                this.notesColumnMappings = {};
                
                // Start with the first Notes column
                this.askForNotesColumnName();
            }
            
            askForNotesColumnName() {
                const currentColumn = this.pendingNotesColumns[this.currentNotesIndex];
                const message = `Found "${currentColumn}" column in your file. What would you like to name this column in the table?`;
                
                const customName = prompt(message, currentColumn);
                
                if (customName === null) {
                    // User cancelled, skip this column
                    this.skipCurrentNotesColumn();
                    return;
                }
                
                if (!customName.trim()) {
                    alert('Please enter a valid column name.');
                    this.askForNotesColumnName(); // Ask again
                    return;
                }
                
                // Store the mapping
                this.notesColumnMappings[currentColumn] = customName.trim();
                
                // Move to next column or finish
                this.currentNotesIndex++;
                if (this.currentNotesIndex < this.pendingNotesColumns.length) {
                    this.askForNotesColumnName();
                } else {
                    this.applyNotesColumnMappings();
                }
            }
            
            skipCurrentNotesColumn() {
                this.currentNotesIndex++;
                if (this.currentNotesIndex < this.pendingNotesColumns.length) {
                    this.askForNotesColumnName();
                } else {
                    this.applyNotesColumnMappings();
                }
            }
            
            applyNotesColumnMappings() {
                if (Object.keys(this.notesColumnMappings).length === 0) {
                    // No mappings, proceed normally
                    this.askForOwnerName(this.pendingFile);
                    return;
                }
                
                // Apply column name mappings to the data
                this.pendingFile.data = this.pendingFile.data.map(row => {
                    const newRow = { ...row };
                    
                    // Rename Notes columns
                    Object.entries(this.notesColumnMappings).forEach(([oldName, newName]) => {
                        if (oldName in newRow) {
                            newRow[newName] = newRow[oldName];
                            // Only delete the old column if the name is actually different
                            if (oldName !== newName) {
                                delete newRow[oldName];
                            }
                        }
                    });
                    
                    return newRow;
                });
                
                // Add the new column names to custom columns
                Object.values(this.notesColumnMappings).forEach(newName => {
                    if (!this.customColumns.includes(newName)) {
                        this.customColumns.push(newName);
                    }
                });
                
                // Clean up
                this.pendingNotesColumns = null;
                this.notesColumnMappings = null;
                this.currentNotesIndex = 0;
                
                // Continue with normal flow
                this.askForOwnerName(this.pendingFile);
            }

            askForOwnerName(fileData) {
                this.pendingFile = fileData;
                document.getElementById('currentFileName').textContent = fileData.fileName;
                document.getElementById('shortlistOwner').value = fileData.fileName; // Default to filename
                const modal = new bootstrap.Modal(document.getElementById('nameModal'));
                modal.show();
                
                // Focus on input and select default text
                setTimeout(() => {
                    const input = document.getElementById('shortlistOwner');
                    input.focus();
                    input.select();
                }, 500);
            }

            saveShortlistName() {
                const ownerName = document.getElementById('shortlistOwner').value.trim();
                if (!ownerName) {
                    alert('Please enter a name for this shortlist');
                    return;
                }

                if (this.pendingFile) {
                    this.pendingFile.owner = ownerName;
                    this.pendingFile.name = ownerName; // Use owner name as display name
                    
                    // Upload to persistent storage if current sale is selected
                    const currentSaleId = document.getElementById('saleSelector').value;
                    if (currentSaleId) {
                        this.uploadFileToPersistentStorage(this.pendingFile, currentSaleId);
                    }
                    
                    this.files.push(this.pendingFile);
                    this.updateFileList();
                    this.updateCombineButton();
                    this.pendingFile = null;
                    this.autoSave(); // Auto-save after adding file
                }

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('nameModal')).hide();
                
                // Clear form
                document.getElementById('shortlistOwner').value = '';
            }

            updateFileList() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = this.files.map((file, index) => `
                    <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                        <div>
                            <strong>${file.name}</strong> <small class="text-muted">(${file.fileName})</small>
                            <br><small class="text-muted">(${file.data.length} horses${file.type ? `, ${file.type}` : ''}${file.sheet ? `, Sheet: ${file.sheet}` : ''})</small>
                            ${file.errors.length > 0 ? `<span class="badge bg-warning">${file.errors.length} warnings</span>` : ''}
                        </div>
                        <button class="btn btn-sm" onclick="combiner.removeFile(${index})" title="Delete File" style="background-color: transparent; border: 1px solid #ff6600; color: #ff6600;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `).join('');
            }

            async uploadFileToPersistentStorage(fileData, saleId) {
                // File data is already stored in localStorage via saveSalesData()
                // No additional upload needed for GitHub Pages deployment
                console.log(`File ${fileData.name} stored in localStorage for sale ${saleId}`);
            }

            convertDataToCSV(data) {
                if (!data || data.length === 0) return '';
                
                // Get headers from first row
                const headers = Object.keys(data[0]);
                
                // Convert to CSV format
                const csvRows = [headers.join(',')];
                
                for (const row of data) {
                    const values = headers.map(header => {
                        const value = row[header] || '';
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    });
                    csvRows.push(values.join(','));
                }
                
                return csvRows.join('\n');
            }

            removeFile(index) {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                if (!confirm('Are you sure you want to remove this shortlist file?')) {
                    return;
                }
                this.files.splice(index, 1);
                this.updateFileList();
                this.updateCombineButton();
                this.autoSave(); // Auto-save after removing file
            }

            updateCombineButton() {
                document.getElementById('combineBtn').disabled = this.files.length < 1;
            }

            cleanConsignerText(consigner) {
                if (!consigner) return '';
                
                // Remove various terms and everything after them
                let cleaned = consigner.toString();
                
                // Patterns to match and remove (including everything after)
                const patterns = [
                    /, Agent.*$/i,
                    /, Agency.*$/i,
                    / Agent.*$/i,
                    / Agency.*$/i,
                    /Agent.*$/i,
                    /Agency.*$/i,
                    /, LLC.*$/i,
                    / LLC.*$/i,
                    /LLC.*$/i,
                    /, Sales.*$/i,
                    / Sales.*$/i,
                    /Sales.*$/i,
                    /, Farm.*$/i,
                    / Farm.*$/i,
                    /Farm.*$/i,
                    /, Stud.*$/i,
                    / Stud.*$/i,
                    /Stud.*$/i,
                    / at Xalapa.*$/i,
                    /, at Xalapa.*$/i,
                    /at Xalapa.*$/i,
                    /\(Creastwood\)/gi,
                    /\(Bernard McCormack\)/gi
                ];
                
                for (const pattern of patterns) {
                    cleaned = cleaned.replace(pattern, '');
                }
                
                // Remove specific text patterns in parentheses
                cleaned = cleaned.replace(/\(Francis and Barbara Vanlangendonck\),?/gi, '');
                cleaned = cleaned.replace(/\(Francis and Barbara Vanlangendonck\)/gi, '');
                
                // Replace McLean with Crestwood
                cleaned = cleaned.replace(/McLean/gi, 'Crestwood');
                cleaned = cleaned.replace(/Maclean/gi, 'Crestwood');
                
                // Replace BLUEGRASS THOROUGHBRED with just Bluegrass
                if (cleaned.includes('BLUEGRASS THOROUGHBRED')) {
                    cleaned = 'Bluegrass';
                }
                
                // Replace any name containing summerfield with just Summerfield
                if (cleaned.toLowerCase().includes('summerfield')) {
                    cleaned = 'Summerfield';
                }
                
                return cleaned.trim();
            }

            async checkForDeletedHorses() {
                if (this.deletedHorses.length === 0) {
                    return true; // No deleted horses, proceed normally
                }

                // Check if any of the deleted horses appear in the current file data
                const deletedHorsesInFiles = [];
                this.files.forEach(file => {
                    file.data.forEach(row => {
                        const hipNumber = row.Hip || row['Horse Name'] || row['Name'] || Object.values(row)[0];
                        if (hipNumber && this.deletedHorses.includes(hipNumber)) {
                            if (!deletedHorsesInFiles.includes(hipNumber)) {
                                deletedHorsesInFiles.push(hipNumber);
                            }
                        }
                    });
                });

                if (deletedHorsesInFiles.length === 0) {
                    return true; // No deleted horses found in files, proceed normally
                }

                // Show popup asking user what to do
                const hipList = deletedHorsesInFiles.join(', ');
                const message = `Found ${deletedHorsesInFiles.length} previously deleted horse${deletedHorsesInFiles.length > 1 ? 's' : ''}: ${hipList}\n\nDo you want to restore ${deletedHorsesInFiles.length > 1 ? 'these horses' : 'this horse'}?`;
                
                return confirm(message);
            }

            async combineData() {
                if (this.files.length === 0) return;

                // Check for previously deleted horses in the new data
                const deletedHorsesFound = await this.checkForDeletedHorses();
                if (deletedHorsesFound === false) {
                    // User clicked "No" - proceed but don't restore deleted horses
                } else if (deletedHorsesFound === true) {
                    // User clicked "Yes" or no deleted horses found - proceed normally
                }

                // Check if any uploaded files match previously deleted columns and restore them
                if (this.currentSaleId) {
                    const saleInfo = this.salesData.get(this.currentSaleId);
                    if (saleInfo && saleInfo.deletedColumns) {
                        const currentFileNames = this.files.map(f => f.name);
                        // Remove any file names from deletedColumns if they're being re-uploaded
                        saleInfo.deletedColumns = saleInfo.deletedColumns.filter(deletedCol => 
                            !currentFileNames.includes(deletedCol)
                        );
                    }
                }

                // Create a map of all unique horses - preserve existing data if recombining
                const horseMap = new Map();
                
                // If we already have combined data, preserve it
                if (this.combinedData.length > 0) {
                    this.combinedData.forEach(row => {
                        const key = row.Hip || row['Name'] || row['Horse Name'];
                        if (key) {
                            horseMap.set(key, { ...row, shortlists: {} });
                        }
                    });
                }
                
                // First pass: collect all unique horses and their basic info
                this.files.forEach(file => {
                    file.data.forEach(row => {
                        const key = row.Hip || row['Horse Name'] || row['Name'] || Object.values(row)[0];
                        if (!key) return;

                        // Skip deleted horses if user chose not to restore them
                        const hipNumber = row.Hip || key;
                        if (!deletedHorsesFound && this.deletedHorses.includes(hipNumber)) {
                            return;
                        }

                        if (!horseMap.has(key)) {
                            // Store the most complete horse info with permanent columns and custom columns
                            const newHorse = {
                                Hip: row.Hip || '',
                                'Name': row['Horse Name'] || row['Name'] || '',
                                Sire: row.Sire || '',
                                Dam: row.Dam || '',
                                Sex: row.Sex || '',
                                YOB: row.YOB || '',
                                Consignor: this.cleanConsignerText(row.Consignor || ''),
                                Barn: row.Barn || '',
                                Vet: '', // Permanent column
                                Scope: '', // Permanent column
                                Notes: '', // Permanent column
                                Reserve: '', // Permanent column
                                Result: '', // Permanent column
                                shortlists: {}
                            };
                            
                            // Add any custom columns (like Notes) from the row
                            this.customColumns.forEach(customCol => {
                                if (customCol in row) {
                                    newHorse[customCol] = row[customCol] || '';
                                }
                            });
                            
                            horseMap.set(key, newHorse);
                        } else {
                            // Update with non-empty values (but preserve permanent columns)
                            const existing = horseMap.get(key);
                            Object.keys(row).forEach(col => {
                                if (row[col] && row[col].toString().trim() !== '' && 
                                    col !== 'Selection' && col !== 'Comment' &&
                                    !['Vet', 'Scope', 'Notes', 'Reserve', 'Result'].includes(col)) {
                                    if (col === 'Consignor') {
                                        existing[col] = this.cleanConsignerText(row[col]);
                                    } else {
                                        existing[col] = row[col];
                                    }
                                }
                            });
                        }
                    });
                });

                // Second pass: add shortlist ratings
                this.files.forEach(file => {
                    file.data.forEach(row => {
                        const key = row.Hip || row['Horse Name'] || row['Name'] || Object.values(row)[0];
                        if (!key || !horseMap.has(key)) return;

                        // Skip deleted horses if user chose not to restore them
                        const hipNumber = row.Hip || key;
                        if (!deletedHorsesFound && this.deletedHorses.includes(hipNumber)) {
                            return;
                        }

                        const horse = horseMap.get(key);
                        const rating = row.Selection || row.Rating || row.Grade || '';
                        // If horse is on this person's shortlist, show rating or "X" if no rating
                        horse.shortlists[file.name] = rating || 'X';
                    });
                });

                // Convert to array format
                this.combinedData = Array.from(horseMap.values()).map(horse => {
                    const row = { ...horse };
                    delete row.shortlists;
                    
                    // Add each person's rating as a column
                    this.files.forEach(file => {
                        row[file.name] = horse.shortlists[file.name] || '';
                    });
                    
                    // Calculate overlap count (including "X" marks)
                    const ratingCount = Object.values(horse.shortlists).filter(r => r && r.toString().trim() !== '').length;
                    row['Overlap'] = ratingCount;
                    
                    return row;
                });

                // Sort by hip number after combining
                this.combinedData.sort((a, b) => {
                    const hipA = a.Hip || '';
                    const hipB = b.Hip || '';
                    
                    // Handle 'NEW' entries - put them at the end
                    if (hipA === 'NEW' && hipB !== 'NEW') return 1;
                    if (hipB === 'NEW' && hipA !== 'NEW') return -1;
                    if (hipA === 'NEW' && hipB === 'NEW') return 0;
                    
                    // Convert to numbers for proper numeric sorting
                    const numA = parseInt(hipA) || 0;
                    const numB = parseInt(hipB) || 0;
                    
                    return numA - numB;
                });

                // Set sort state to Hip since we just sorted by hip number
                this.sortState = { column: 'Hip', direction: 'asc' };

                // If user chose to restore deleted horses, remove them from deleted list
                if (deletedHorsesFound) {
                    const restoredHips = this.combinedData.map(row => row.Hip).filter(hip => 
                        this.deletedHorses.includes(hip)
                    );
                    restoredHips.forEach(hip => {
                        const index = this.deletedHorses.indexOf(hip);
                        if (index > -1) {
                            this.deletedHorses.splice(index, 1);
                        }
                    });
                }

                this.createTable();
                this.updateStats();
                this.showResults();
                this.autoSave(); // Auto-save after combining data
            }

            createTable() {
                const tableHead = document.querySelector('#mainTable thead');
                const tableBody = document.querySelector('#mainTable tbody');

                if (this.combinedData.length === 0) return;

                // Get globally deleted columns for this sale
                const saleInfo = this.currentSaleId ? this.salesData.get(this.currentSaleId) : null;
                const deletedColumns = saleInfo?.deletedColumns || [];

                // Define column order: basic horse info, then Notes, shortlists, Scope, Vet, Reserve, Result, overlap count
                const basicColumns = ['Hip', 'Name', 'Sire', 'Dam', 'Sex', 'YOB', 'Consignor'];
                const shortlistColumns = this.files.map(f => f.name);
                const trailingColumns = ['Scope', 'Vet', 'Reserve', 'Result'];
                const metaColumns = ['Overlap'];
                
                // If we have data but no files (e.g., imported CSV), use the actual columns from the data
                let actualDataColumns = [];
                if (this.combinedData.length > 0 && this.files.length === 0) {
                    actualDataColumns = Object.keys(this.combinedData[0]);
                }
                
                // Initialize column order if not set or if we need to add new columns
                if (this.columnOrder.length === 0) {
                    if (actualDataColumns.length > 0) {
                        // Use columns from imported data exactly as they are
                        this.columnOrder = [...actualDataColumns];
                    } else {
                        // Use standard layout for shortlist combinations
                        this.columnOrder = [...basicColumns, 'Notes', ...shortlistColumns, ...trailingColumns, ...metaColumns, ...this.customColumns];
                    }
                } else {
                    // If we have imported data columns, add any missing ones
                    if (actualDataColumns.length > 0) {
                        actualDataColumns.forEach(col => {
                            if (!this.columnOrder.includes(col)) {
                                this.columnOrder.push(col);
                            }
                        });
                    } else {
                        // Standard shortlist logic
                        
                        // Add Notes if missing (should be after basic columns)
                        if (!this.columnOrder.includes('Notes')) {
                            const insertIndex = basicColumns.length;
                            this.columnOrder.splice(insertIndex, 0, 'Notes');
                        }
                        
                        // Add any new shortlist columns (after Notes)
                        shortlistColumns.forEach(col => {
                            if (!this.columnOrder.includes(col)) {
                                const notesIndex = this.columnOrder.indexOf('Notes');
                                this.columnOrder.splice(notesIndex + 1, 0, col);
                            }
                        });
                        
                        // Add trailing columns if missing
                        trailingColumns.forEach(col => {
                            if (!this.columnOrder.includes(col)) {
                                const overlapIndex = this.columnOrder.indexOf('Overlap');
                                this.columnOrder.splice(overlapIndex, 0, col);
                            }
                        });
                        
                        // Add any new custom columns (preserve their current position if already in columnOrder)
                        this.customColumns.forEach(col => {
                            if (!this.columnOrder.includes(col)) {
                                // Only add if not already in columnOrder - this preserves user's custom positioning
                                this.columnOrder.push(col);
                            }
                        });
                    }
                }
                
                // Always hide Barn column
                this.hiddenColumns.add('Barn');
                
                // Filter out globally deleted columns from column order and hidden columns
                this.columnOrder = this.columnOrder.filter(col => !deletedColumns.includes(col));
                deletedColumns.forEach(col => this.hiddenColumns.delete(col));
                
                // Apply current column order and filter hidden columns
                const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                
                // Create header with sorting and drag-drop, plus delete column
                const headerRow = visibleColumns.map(col => {
                    let headerClass = 'sortable-header';
                    if (shortlistColumns.includes(col)) {
                        headerClass += ' shortlist-header';
                    }
                    
                    const sortIcon = this.getSortIcon(col);
                    
                    return `<th class="${headerClass}" data-column="${col}" draggable="true">
                        ${col}
                        <span class="sort-icon ${this.sortState.column === col ? 'active' : ''}">${sortIcon}</span>
                    </th>`;
                }).join('') + '<th class="text-center">Delete</th>';
                
                // Create filter row if visible
                const filterRow = this.filtersVisible ? `
                    <tr class="filter-row">
                        ${visibleColumns.map(col => `
                            <th>
                                ${col === 'Vet' ? `
                                    <div>
                                        <select class="filter-input vet-filter-select" data-column="${col}" style="width: 100%; margin-bottom: 2px;">
                                            <option value="">All</option>
                                            <option value="__REMOVE_BLANKS__" ${this.filters[col] === '__REMOVE_BLANKS__' ? 'selected' : ''}>Remove blanks</option>
                                            <option value="__CUSTOM__" ${this.filters[col] && this.filters[col] !== '__REMOVE_BLANKS__' && this.filters[col] !== '' ? 'selected' : ''}>Custom</option>
                                        </select>
                                        <input type="text" class="filter-input vet-custom-input" placeholder="Enter text to filter" 
                                               data-column="${col}" value="${this.filters[col] && this.filters[col] !== '__REMOVE_BLANKS__' && this.filters[col] !== '__CUSTOM__' ? this.filters[col] : ''}"
                                               style="width: 100%; font-size: 11px; display: ${this.filters[col] && this.filters[col] !== '__REMOVE_BLANKS__' && this.filters[col] !== '' ? 'block' : 'none'};">
                                    </div>
                                ` : col === 'Hip' ? `
                                    <div>
                                        <select class="filter-input hip-filter-select" data-column="${col}" style="width: 100%; margin-bottom: 2px;">
                                            <option value="">All</option>
                                            <option value="__RANGE__" ${this.filters[col] && this.filters[col].includes('-') ? 'selected' : ''}>Range</option>
                                        </select>
                                        <div style="display: ${this.filters[col] && this.filters[col].includes('-') ? 'block' : 'none'};">
                                            <input type="number" class="filter-input hip-range-from" placeholder="From" min="1"
                                                   data-column="${col}" value="${this.filters[col] && this.filters[col].includes('-') ? this.filters[col].split('-')[0] : ''}"
                                                   style="width: 48%; font-size: 11px; margin-bottom: 2px;">
                                            <input type="number" class="filter-input hip-range-to" placeholder="To" min="1"
                                                   data-column="${col}" value="${this.filters[col] && this.filters[col].includes('-') ? this.filters[col].split('-')[1] : ''}"
                                                   style="width: 48%; font-size: 11px; float: right;">
                                        </div>
                                    </div>
                                ` : `
                                    <input type="text" class="filter-input" placeholder="Filter ${col}" 
                                           data-column="${col}" value="${this.filters[col] || ''}">
                                `}
                            </th>
                        `).join('')}
                        <th></th>
                    </tr>
                ` : '';
                
                tableHead.innerHTML = `
                    <tr class="header-row">${headerRow}</tr>
                    ${filterRow}
                `;

                // Apply current filters and sorting
                let filteredData = this.applyFilters(this.combinedData);
                filteredData = this.applySorting(filteredData);

                // Create body
                tableBody.innerHTML = filteredData.map((row, rowIndex) => `
                    <tr>
                        ${visibleColumns.map(col => {
                            let cellContent = row[col] || '';
                            const originalValue = cellContent; // Store original value
                            
                            // Format consignor names
                            if (col === 'Consignor') {
                                if (cellContent.includes('Bluegrass Thoroughbred Services')) {
                                    cellContent = 'Bluegrass';
                                } else if (cellContent.includes('(Crestwood)') || cellContent.includes('(Crestwood')) {
                                    cellContent = 'Crestwood';
                                }
                            }
                            let cellClass = 'editable-cell';
                            
                            // Style based on column type
                            if (col === 'Hip') {
                                cellClass += ' hip-column';
                                
                                // Check if URL template exists for this sale
                                const saleInfo = this.salesData.get(this.currentSaleId);
                                const hasUrlTemplate = saleInfo?.hipUrlTemplate;
                                
                                // Make Hip non-editable if URL template exists, unless it's a new horse
                                const isNewHorse = cellContent === 'NEW' || cellContent === 'New Horse';
                                if (hasUrlTemplate && !isNewHorse) {
                                    cellClass = cellClass.replace('editable-cell', 'non-editable-cell');
                                }
                                
                                // Generate clickable link if URL template exists and hip number is valid
                                const hipUrl = this.generateHipUrl(cellContent, saleInfo);
                                if (hipUrl && cellContent && !isNewHorse) {
                                    cellContent = `<a href="${hipUrl}" target="_blank" style="text-decoration: underline; color: inherit;" title="View PDF for Hip ${cellContent}">${cellContent}</a>`;
                                }
                            } else if (['Name', 'Sire', 'Dam', 'Consignor'].includes(col)) {
                                cellClass += ' horse-info';
                            } else if (col === 'Vet') {
                                cellClass += ' vet-cell';
                            } else if (['Scope', 'Notes', 'Reserve', 'Result'].includes(col)) {
                                // These are already editable via the base class
                            } else if (shortlistColumns.includes(col)) {
                                cellClass += ' grade-cell';
                                // Add grade-specific styling
                                const grade = cellContent.toString().toUpperCase();
                                if (grade.includes('A+') || grade.includes('A PLUS')) {
                                    cellClass += ' grade-A-plus';
                                } else if (grade.includes('A')) {
                                    cellClass += ' grade-A';
                                } else if (grade.includes('B+') || grade.includes('B PLUS')) {
                                    cellClass += ' grade-B-plus';
                                } else if (grade.includes('B')) {
                                    cellClass += ' grade-B';
                                } else if (grade.includes('C')) {
                                    cellClass += ' grade-C';
                                } else if (grade.includes('D')) {
                                    cellClass += ' grade-D';
                                }
                            } else if (this.customColumns.includes(col)) {
                                // Custom columns (like Notes) - no special styling, just editable
                                // Keep default editable-cell class without grade colors
                            } else if (col === 'Overlap') {
                                const count = parseInt(cellContent);
                                cellContent = count > 1 ? `<strong>${count}</strong>` : '';
                                cellClass = ''; // Not editable
                            }

                            return `<td class="${cellClass}" data-column="${col}" data-original-value="${originalValue}" style="display: table-cell !important; position: static !important; width: auto !important;">${cellContent}</td>`;
                        }).join('')}
                        <td class="text-center" style="display: table-cell !important; position: static !important; width: auto !important;">
                            <button class="btn btn-sm btn-primary delete-horse-btn" data-row-index="${rowIndex}" title="Delete this horse" style="z-index: 1000;" onclick="combiner.deleteHorse(${rowIndex}); return false;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Setup all event listeners
                this.setupTableEventListeners();
                this.setupColumnControls();
                this.setupCellEditing();
                
                // Fix iPad/iPhone sticky headers
                this.fixiPadTable();
            }

            getSortIcon(column) {
                if (this.sortState.column === column) {
                    return this.sortState.direction === 'asc' ? '▲' : '▼';
                }
                return '↕';
            }

            applyFilters(data) {
                return data.filter(row => {
                    return Object.keys(this.filters).every(column => {
                        const filterValue = this.filters[column];
                        if (!filterValue) return true;
                        
                        // Special handling for "Remove blanks" option in Vet column
                        if (filterValue === '__REMOVE_BLANKS__') {
                            const cellValue = (row[column] || '').toString().trim();
                            return cellValue !== ''; // Only show rows with non-empty values
                        }
                        
                        // Special handling for Hip range filtering
                        if (column === 'Hip' && filterValue.includes('-')) {
                            const [fromStr, toStr] = filterValue.split('-');
                            const fromValue = parseInt(fromStr);
                            const toValue = parseInt(toStr);
                            const hipValue = parseInt(row[column]) || 0;
                            
                            if (fromValue && toValue && hipValue) {
                                return hipValue >= fromValue && hipValue <= toValue;
                            }
                            return false; // Invalid range or hip value
                        }
                        
                        // Regular text filtering
                        const cellValue = (row[column] || '').toString().toLowerCase();
                        return cellValue.includes(filterValue.toLowerCase());
                    });
                });
            }

            applySorting(data) {
                if (!this.sortState.column) return data;
                
                return [...data].sort((a, b) => {
                    let aVal = a[this.sortState.column] || '';
                    let bVal = b[this.sortState.column] || '';
                    
                    // Handle numeric columns
                    if (this.sortState.column === 'Hip' || this.sortState.column === 'Overlap' || this.sortState.column === 'YOB') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    } else {
                        aVal = aVal.toString().toLowerCase();
                        bVal = bVal.toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return this.sortState.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            setupTableEventListeners() {
                // Header click for sorting
                $('#mainTable thead').off('click').on('click', '.sortable-header', (e) => {
                    const column = $(e.currentTarget).data('column');
                    this.handleSort(column);
                });

                // Filter input events with debouncing
                let filterTimeout;
                $('#mainTable thead').off('input change').on('input change', '.filter-input', (e) => {
                    const column = $(e.target).data('column');
                    const value = e.target.value;
                    
                    // Special handling for Vet filter
                    if (column === 'Vet') {
                        if ($(e.target).hasClass('vet-filter-select')) {
                            // Dropdown selection
                            if (value === '__CUSTOM__') {
                                // Show custom input field
                                $(e.target).siblings('.vet-custom-input').show();
                                return; // Don't apply filter yet, wait for custom input
                            } else {
                                // Hide custom input field
                                $(e.target).siblings('.vet-custom-input').hide().val('');
                                this.filters[column] = value;
                            }
                        } else if ($(e.target).hasClass('vet-custom-input')) {
                            // Custom text input
                            this.filters[column] = value;
                            // Update dropdown to show Custom is selected
                            $(e.target).siblings('.vet-filter-select').val('__CUSTOM__');
                        }
                    } else if (column === 'Hip') {
                        if ($(e.target).hasClass('hip-filter-select')) {
                            // Hip dropdown selection
                            if (value === '__RANGE__') {
                                // Show range input fields
                                $(e.target).siblings('div').show();
                                return; // Don't apply filter yet, wait for range inputs
                            } else {
                                // Hide range input fields
                                $(e.target).siblings('div').hide();
                                $(e.target).siblings('div').find('.hip-range-from, .hip-range-to').val('');
                                this.filters[column] = value;
                            }
                        } else if ($(e.target).hasClass('hip-range-from') || $(e.target).hasClass('hip-range-to')) {
                            // Hip range inputs
                            const fromInput = $(e.target).closest('div').find('.hip-range-from');
                            const toInput = $(e.target).closest('div').find('.hip-range-to');
                            const fromValue = parseInt(fromInput.val()) || '';
                            const toValue = parseInt(toInput.val()) || '';
                            
                            if (fromValue && toValue) {
                                this.filters[column] = `${fromValue}-${toValue}`;
                                // Update dropdown to show Range is selected
                                $(e.target).closest('div').siblings('.hip-filter-select').val('__RANGE__');
                            } else if (!fromValue && !toValue) {
                                this.filters[column] = '';
                            } else {
                                return; // Don't apply filter until both values are entered
                            }
                        }
                    } else {
                        // Regular filter for other columns
                        this.filters[column] = value;
                    }
                    
                    // Debounce table recreation
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => {
                        this.createTable(); // Refresh table with new filters
                        this.autoSave(); // Auto-save after changing filters
                    }, 300);
                });

                // Delete horse button event
                $('#mainTable tbody').off('click', '.delete-horse-btn').on('click', '.delete-horse-btn', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Delete button clicked');
                    const rowIndex = parseInt($(e.currentTarget).data('row-index'));
                    console.log('Row index:', rowIndex);
                    this.deleteHorse(rowIndex);
                });

                // Drag and drop for column reordering
                this.setupDragAndDrop();
            }

            setupDragAndDrop() {
                let draggedColumn = null;

                $('#mainTable thead th').off('dragstart dragover drop').on({
                    dragstart: (e) => {
                        draggedColumn = $(e.currentTarget).data('column');
                        $(e.currentTarget).addClass('dragging');
                    },
                    dragend: (e) => {
                        $(e.currentTarget).removeClass('dragging');
                        $('.drop-indicator').remove();
                    },
                    dragover: (e) => {
                        e.preventDefault();
                        const targetColumn = $(e.currentTarget).data('column');
                        if (draggedColumn !== targetColumn) {
                            // Visual feedback for drop position
                            $('.drop-indicator').remove();
                            const indicator = $('<div class="drop-indicator"></div>');
                            $(e.currentTarget).before(indicator);
                        }
                    },
                    drop: (e) => {
                        e.preventDefault();
                        const targetColumn = $(e.currentTarget).data('column');
                        if (draggedColumn && draggedColumn !== targetColumn) {
                            this.reorderColumns(draggedColumn, targetColumn);
                        }
                        $('.drop-indicator').remove();
                    }
                });
            }

            setupColumnControls() {
                // Generate column checkboxes
                const checkboxContainer = document.getElementById('columnCheckboxes');
                const reorderSelect = document.getElementById('columnReorder');
                
                checkboxContainer.innerHTML = '';
                reorderSelect.innerHTML = '<option value="">Select column to move...</option>';
                
                this.columnOrder.forEach(col => {
                    // Checkbox for show/hide
                    const checkbox = document.createElement('div');
                    checkbox.className = 'column-checkbox';
                    checkbox.innerHTML = `
                        <label>
                            <input type="checkbox" ${this.hiddenColumns.has(col) ? '' : 'checked'} 
                                   data-column="${col}">
                            ${col}
                        </label>
                    `;
                    checkboxContainer.appendChild(checkbox);
                    
                    // Option for reorder select
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    reorderSelect.appendChild(option);
                });

                // Add event listeners for checkboxes with debouncing
                let debounceTimeout;
                checkboxContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const column = e.target.dataset.column;
                        if (e.target.checked) {
                            this.hiddenColumns.delete(column);
                        } else {
                            this.hiddenColumns.add(column);
                        }
                        
                        // Debounce table recreation for better performance
                        clearTimeout(debounceTimeout);
                        debounceTimeout = setTimeout(() => {
                            this.saveUserColumnPreferences(); // Save user preferences
                            this.createTable();
                            this.autoSave();
                        }, 150);
                    }
                });
            }

            handleSort(column) {
                if (this.sortState.column === column) {
                    this.sortState.direction = this.sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortState.column = column;
                    this.sortState.direction = 'asc';
                }
                this.createTable();
                this.autoSave(); // Auto-save after sorting
            }

            reorderColumns(draggedCol, targetCol) {
                const draggedIndex = this.columnOrder.indexOf(draggedCol);
                const targetIndex = this.columnOrder.indexOf(targetCol);
                
                // Remove dragged column and insert at target position
                this.columnOrder.splice(draggedIndex, 1);
                this.columnOrder.splice(targetIndex, 0, draggedCol);
                
                this.saveUserColumnPreferences(); // Save user preferences
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after reordering columns
            }

            selectAllColumns() {
                this.hiddenColumns.clear();
                this.saveUserColumnPreferences(); // Save user preferences
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after selecting all columns
            }

            deselectAllColumns() {
                this.columnOrder.forEach(col => this.hiddenColumns.add(col));
                // Keep at least Hip and Horse Name visible
                this.hiddenColumns.delete('Hip');
                this.hiddenColumns.delete('Horse Name');
                this.saveUserColumnPreferences(); // Save user preferences
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after deselecting all columns
            }

            resetColumnLayout() {
                const basicColumns = ['Hip', 'Name', 'Sire', 'Dam', 'Sex', 'YOB', 'Consignor'];
                const shortlistColumns = this.files.map(f => f.name);
                const trailingColumns = ['Scope', 'Vet', 'Reserve', 'Result'];
                const metaColumns = ['Overlap'];
                
                this.columnOrder = [...basicColumns, 'Notes', ...shortlistColumns, ...trailingColumns, ...metaColumns, ...this.customColumns];
                this.hiddenColumns.clear();
                this.hiddenColumns.add('Barn'); // Always hide Barn
                this.sortState = { column: 'Overlap', direction: 'desc' };
                this.filters = {};
                
                this.saveUserColumnPreferences(); // Save user preferences
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after resetting column layout
            }

            toggleFilters() {
                this.filtersVisible = !this.filtersVisible;
                this.saveUserColumnPreferences(); // Save user preferences
                this.createTable();
                
                const btn = document.getElementById('toggleFiltersBtn');
                btn.innerHTML = this.filtersVisible ? 
                    '<i class="fas fa-filter"></i> Hide' : 
                    '<i class="fas fa-filter"></i> Filters';
            }

            clearAllFilters() {
                this.filters = {};
                this.createTable();
                this.autoSave();
            }

            moveColumn(direction) {
                const select = document.getElementById('columnReorder');
                const selectedColumn = select.value;
                if (!selectedColumn) return;
                
                const currentIndex = this.columnOrder.indexOf(selectedColumn);
                const newIndex = direction === 'left' ? Math.max(0, currentIndex - 1) : Math.min(this.columnOrder.length - 1, currentIndex + 1);
                
                if (newIndex !== currentIndex) {
                    this.columnOrder.splice(currentIndex, 1);
                    this.columnOrder.splice(newIndex, 0, selectedColumn);
                    this.saveUserColumnPreferences(); // Save user preferences
                    this.createTable();
                    this.setupColumnControls();
                    select.value = selectedColumn; // Maintain selection
                    this.autoSave(); // Auto-save after moving column
                }
            }

            cancelAllEdits() {
                // Find all editing cells and cancel them immediately
                $('.editing').each(function() {
                    const $cell = $(this);
                    const originalValue = $cell.data('original-value') || '';
                    $cell.removeClass('editing').text(originalValue);
                    // Clear explicit dimensions
                    $cell.css({
                        'width': '',
                        'height': '',
                        'box-sizing': ''
                    });
                });
            }

            setupCellEditing() {
                const shortlistColumns = this.files.map(f => f.name);
                
                // Remove any existing event listeners to prevent conflicts
                $('#mainTable tbody').off('click', '.editable-cell');
                
                // Use event delegation for better performance
                $('#mainTable tbody').on('click', '.editable-cell', (e) => {
                    const cell = $(e.target);
                    
                    // Skip if already editing
                    if (cell.hasClass('editing')) return;
                    
                    // Skip if cell is non-editable (like protected Hip numbers)
                    if (cell.hasClass('non-editable-cell')) return;

                    // Check if in edit mode
                    if (!this.isEditMode) {
                        alert('Click the Edit button to enable editing');
                        return;
                    }

                    // Check if sale is frozen
                    if (this.checkIfSaleFrozen()) {
                        this.showFrozenError();
                        return;
                    }

                    // Cancel ALL existing edits immediately
                    this.cancelAllEdits();

                    const currentValue = cell.data('original-value') || '';
                    const column = cell.data('column');
                    
                    // Don't allow editing of non-editable columns
                    if (column === 'Overlap') return;
                    
                    cell.addClass('editing');
                    
                    // Create appropriate input based on column type
                    let input;
                    if (column === 'Vet' || column === 'Scope') {
                        // Text input for Vet and Scope columns
                        input = $(`<input type="text" class="edit-input" value="${currentValue}">`);
                    } else if (shortlistColumns.includes(column)) {
                        // Text input for grades (shortlist columns)
                        input = $(`<input type="text" class="edit-input" value="${currentValue}">`);
                    } else if (this.customColumns.includes(column)) {
                        // Text input for custom columns (like Notes)
                        input = $(`<input type="text" class="edit-input" value="${currentValue}">`);
                    } else {
                        // Text input for other columns
                        input = $(`<input type="text" class="edit-input" value="${currentValue}">`);
                    }
                    
                    // Store original value for cancel functionality
                    input.data('original-value', currentValue);
                    
                    // Preserve cell dimensions before editing
                    const cellWidth = cell.outerWidth();
                    const cellHeight = cell.outerHeight();
                    
                    cell.html(input);
                    
                    // Set explicit dimensions to prevent resizing
                    cell.css({
                        'width': cellWidth + 'px',
                        'height': cellHeight + 'px',
                        'box-sizing': 'border-box'
                    });
                    input.focus();
                    // Position cursor at the end instead of selecting all text
                    if (input.is('input') && currentValue) {
                        const inputElement = input[0];
                        inputElement.setSelectionRange(currentValue.length, currentValue.length);
                    }
                    

                    const saveEdit = (newValue) => {
                        // Handle special formatting for Reserve column
                        if (column === 'Reserve' && newValue && !newValue.startsWith('$')) {
                            newValue = '$' + newValue;
                        }
                        
                        // Update the original data
                        const rowIndex = cell.closest('tr').index();
                        const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                        const dataIndex = this.getDataIndexFromRowIndex(rowIndex);
                        
                        if (dataIndex >= 0) {
                            // SAVE UNDO STATE BEFORE MAKING CHANGE - completely safe, won't affect existing logic
                            this.saveUndoState('edit', {
                                dataIndex: dataIndex,
                                column: column,
                                oldValue: currentValue,
                                newValue: newValue,
                                hip: this.combinedData[dataIndex]['Hip'] || 'Unknown'
                            });
                            
                            this.combinedData[dataIndex][column] = newValue;
                        }
                        
                        // Update stats immediately if Vet or Result column was edited
                        if (column === 'Vet') {
                            this.updateVettingStat();
                        }
                        if (column === 'Result') {
                            this.updatePurchasedStat();
                        }
                        
                        // Refresh the table to apply styling
                        this.createTable();
                        console.log('Cell edited, auto-saving data changes for all users...', column, newValue);
                        this.autoSave(); // Auto-save after cell edit
                    };

                    const cancelEdit = () => {
                        cell.removeClass('editing').text(currentValue);
                        // Clear explicit dimensions
                        cell.css({
                            'width': '',
                            'height': '',
                            'box-sizing': ''
                        });
                    };

                    // Text input event handling for all editable cells
                        input.on('blur keypress touchend', (e) => {
                            if (e.type === 'blur' || e.which === 13 || e.type === 'touchend') {
                                saveEdit(input.val());
                            } else if (e.which === 27) { // Escape key
                                cancelEdit();
                            }
                        });
                        
                        // Better touch handling for mobile/iPad
                        input.on('focus', () => {
                            // Prevent the page from scrolling when input is focused on iOS
                            setTimeout(() => {
                                input[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 300);
                        });
                });
            }

            getDataIndexFromRowIndex(rowIndex) {
                // This is a simplified mapping - in a more complex scenario, 
                // you'd need to track the mapping between filtered/sorted rows and original data
                let filteredData = this.applyFilters(this.combinedData);
                filteredData = this.applySorting(filteredData);
                
                if (rowIndex < filteredData.length) {
                    const rowData = filteredData[rowIndex];
                    return this.combinedData.findIndex(row => 
                        row.Hip === rowData.Hip && (row['Name'] === rowData['Name'] || row['Horse Name'] === rowData['Horse Name'])
                    );
                }
                return -1;
            }

            updateStats() {
                const total = this.combinedData.length;
                const overlapping = this.combinedData.filter(row => row['Overlap'] > 1).length;
                
                // Count purchased horses (any horse with "Repole" in Result column)
                const purchased = this.combinedData.filter(row => 
                    row.Result && row.Result.toString().toLowerCase().includes('repole')
                ).length;
                
                // Count colts and fillies
                const colts = this.combinedData.filter(row => 
                    row.Sex && (row.Sex.toUpperCase() === 'C' || row.Sex.toUpperCase() === 'COLT')
                ).length;
                const fillies = this.combinedData.filter(row => 
                    row.Sex && (row.Sex.toUpperCase() === 'F' || row.Sex.toUpperCase() === 'FILLY')
                ).length;
                
                // Count horses with Y in vet column
                const vetting = this.combinedData.filter(row => 
                    row.Vet && row.Vet.toString().trim() !== ''
                ).length;

                document.getElementById('purchasedCount').textContent = purchased;
                document.getElementById('uniqueHorses').textContent = total;
                document.getElementById('coltCount').textContent = colts;
                document.getElementById('fillyCount').textContent = fillies;
                document.getElementById('vettingCount').textContent = vetting;
                document.getElementById('overlappingHorses').textContent = overlapping;
                document.getElementById('shortlistCount').textContent = this.files.length;
            }

            updateVettingStat() {
                const vetting = this.combinedData.filter(row => 
                    row.Vet && row.Vet.toString().trim() !== ''
                ).length;
                document.getElementById('vettingCount').textContent = vetting;
            }

            updatePurchasedStat() {
                const purchased = this.combinedData.filter(row => 
                    row.Result && row.Result.toString().toLowerCase().includes('repole')
                ).length;
                document.getElementById('purchasedCount').textContent = purchased;
            }

            deleteHorse(filteredRowIndex) {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                
                // Get the filtered and sorted data to find the correct horse
                let filteredData = this.applyFilters(this.combinedData);
                filteredData = this.applySorting(filteredData);
                
                // Get the hip number for the confirmation message
                const horseToDelete = filteredData[filteredRowIndex];
                const hipNumber = horseToDelete ? (horseToDelete.Hip || 'Unknown') : 'Unknown';
                
                if (!confirm(`Are you sure you want to delete Hip ${hipNumber} from the shortlist?`)) {
                    return;
                }

                if (filteredRowIndex < filteredData.length) {
                    const rowToDelete = filteredData[filteredRowIndex];
                    
                    // Find the horse in the original data array using Hip and Name
                    const originalIndex = this.combinedData.findIndex(row => 
                        row.Hip === rowToDelete.Hip && 
                        (row['Name'] === rowToDelete['Name'] || row['Horse Name'] === rowToDelete['Horse Name'])
                    );

                    if (originalIndex >= 0) {
                        console.log(`Deleting horse at index ${originalIndex}:`, rowToDelete);
                        
                        // SAVE UNDO STATE BEFORE DELETING - completely safe
                        const horseToDelete = this.combinedData[originalIndex];
                        this.saveUndoState('delete', {
                            rowIndex: originalIndex,
                            deletedRow: JSON.parse(JSON.stringify(horseToDelete)), // deep copy
                            hip: horseToDelete['Hip'] || 'Unknown'
                        });
                        
                        // Add to deleted horses list for combine tracking
                        const hipNumber = horseToDelete.Hip || horseToDelete['Hip'] || 'Unknown';
                        if (hipNumber !== 'Unknown' && !this.deletedHorses.includes(hipNumber)) {
                            this.deletedHorses.push(hipNumber);
                        }
                        
                        // Remove the horse from combinedData (existing logic unchanged)
                        this.combinedData.splice(originalIndex, 1);
                        
                        // Update statistics and refresh table
                        this.updateStats();
                        this.createTable();
                        
                        // Force save the current sale
                        if (this.currentSaleId) {
                            this.saveSaleDay(this.currentSaleId);
                        }
                        
                        console.log('Horse deleted successfully');
                    } else {
                        console.error('Could not find horse to delete');
                        alert('Error: Could not find horse to delete');
                    }
                } else {
                    console.error('Invalid row index for deletion');
                    alert('Error: Invalid row selection');
                }
            }

            showResults() {
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('controlsSection').style.display = 'block';
            }

            exportCSV() {
                if (this.combinedData.length === 0) return;

                // Get current sale info for title
                const saleInfo = this.currentSaleId ? this.salesData.get(this.currentSaleId) : null;
                const saleTitle = saleInfo ? saleInfo.saleName : 'Combined Shortlist';

                // Get only visible columns
                const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                
                // Sort data by hip number before export
                const sortedData = [...this.combinedData].sort((a, b) => {
                    const hipA = a.Hip || '';
                    const hipB = b.Hip || '';
                    
                    // Handle 'NEW' entries - put them at the end
                    if (hipA === 'NEW' && hipB !== 'NEW') return 1;
                    if (hipB === 'NEW' && hipA !== 'NEW') return -1;
                    if (hipA === 'NEW' && hipB === 'NEW') return 0;
                    
                    // Convert to numbers for proper numeric sorting
                    const numA = parseInt(hipA) || 0;
                    const numB = parseInt(hipB) || 0;
                    
                    return numA - numB;
                });
                
                // Filter data to only include visible columns
                const exportData = sortedData.map(row => {
                    const filteredRow = {};
                    visibleColumns.forEach(col => {
                        filteredRow[col] = row[col] || '';
                    });
                    return filteredRow;
                });

                // Add title row at the top
                const titleRow = {};
                visibleColumns.forEach((col, index) => {
                    titleRow[col] = index === 0 ? saleTitle : '';
                });
                
                // Add empty row for spacing
                const emptyRow = {};
                visibleColumns.forEach(col => {
                    emptyRow[col] = '';
                });

                // Create CSV with custom header structure
                const csvRows = [];
                
                // Add title as first row
                csvRows.push([saleTitle, ...new Array(visibleColumns.length - 1).fill('')]);
                
                // Add empty row for spacing
                csvRows.push(new Array(visibleColumns.length).fill(''));
                
                // Add column headers
                csvRows.push(visibleColumns);
                
                // Add data rows
                exportData.forEach(row => {
                    csvRows.push(visibleColumns.map(col => row[col] || ''));
                });
                
                const csv = csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${saleTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_shortlist.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            exportPDF() {
                if (this.combinedData.length === 0) return;

                // Get current sale info for title
                const saleInfo = this.currentSaleId ? this.salesData.get(this.currentSaleId) : null;
                const saleTitle = saleInfo ? `${saleInfo.saleName} - ${saleInfo.saleDate}` : 'Combined Shortlist';

                // Get only visible columns and data
                const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                const exportData = this.combinedData.map(row => {
                    const filteredRow = {};
                    visibleColumns.forEach(col => {
                        filteredRow[col] = row[col] || '';
                    });
                    return filteredRow;
                });

                // Calculate optimal column widths based on content
                const calculateColumnWidth = (col) => {
                    // Special handling for specific columns
                    if (col === 'Hip') {
                        // Ensure Hip column can fit 3 digits
                        return Math.max(3 * 8 + 10, 35); // 3 digits + padding, min 35 points
                    }
                    
                    if (col === 'Reserve') {
                        // Give more space to Reserve column
                        let maxLength = col.length; // Start with header length
                        exportData.forEach(row => {
                            const cellValue = (row[col] || '').toString();
                            maxLength = Math.max(maxLength, cellValue.length);
                        });
                        return Math.min(Math.max(maxLength * 8 + 20, 60), 180); // Extra space, min 60, max 180
                    }
                    
                    // Check if this is the blank column after Result
                    const visibleColumnIndex = visibleColumns.indexOf(col);
                    const resultIndex = visibleColumns.indexOf('Result');
                    if (resultIndex !== -1 && visibleColumnIndex === resultIndex + 1 && (!col || col.trim() === '')) {
                        // Make blank column much smaller
                        return 20; // Very small width for blank column
                    }
                    
                    // Find the longest content in this column
                    let maxLength = col.length; // Start with header length
                    
                    exportData.forEach(row => {
                        const cellValue = (row[col] || '').toString();
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    
                    // Convert character count to approximate points (8 points per character)
                    return Math.min(Math.max(maxLength * 8, 30), 150); // Min 30, max 150 points
                };

                // Get dynamic column widths
                const columnWidths = visibleColumns.map(col => calculateColumnWidth(col));
                const totalWidth = columnWidths.reduce((sum, width) => sum + width, 0);
                
                // Scale to fit page width (A3 landscape = ~1050 points with margins)
                const maxWidth = 1050;
                const scaleFactor = Math.min(1, maxWidth / totalWidth);
                const finalWidths = columnWidths.map(width => Math.floor(width * scaleFactor));

                // Function to wrap text for better display
                const wrapText = (text, maxLength = 25) => {
                    if (!text) return '';
                    const str = text.toString();
                    if (str.length <= maxLength) return str;
                    
                    const words = str.split(' ');
                    const lines = [];
                    let currentLine = '';
                    
                    for (const word of words) {
                        if ((currentLine + ' ' + word).length <= maxLength) {
                            currentLine += (currentLine ? ' ' : '') + word;
                        } else {
                            if (currentLine) lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                    
                    return lines.join('\n');
                };

                // Create table body with proper formatting and text wrapping
                const tableBody = [
                    // Header row
                    visibleColumns.map(col => ({
                        text: col,
                        style: 'tableHeader',
                        fillColor: '#e8e8e8',
                        alignment: 'center'
                    })),
                    // Data rows
                    ...exportData.map(row => 
                        visibleColumns.map((col, colIndex) => {
                            let cellValue = row[col] || '';
                            
                            // Calculate max length based on column width
                            let maxLength = Math.floor(finalWidths[colIndex] / 8);
                            
                            // Adjust max length for specific columns
                            if (['Hip', 'Sex', 'YOB', 'Vet', 'Scope'].includes(col)) {
                                maxLength = Math.min(maxLength, 8);
                            } else if (['Name', 'Sire', 'Dam', 'Consignor'].includes(col)) {
                                maxLength = Math.max(maxLength, 15);
                            }
                            
                            return {
                                text: wrapText(cellValue, maxLength),
                                style: 'tableCell',
                                alignment: 'center'
                            };
                        })
                    )
                ];

                const docDefinition = {
                    content: [
                        { 
                            text: saleTitle, 
                            style: 'title' 
                        },
                        { 
                            text: `${exportData.length} horses | ${this.files.length} shortlists`, 
                            style: 'subtitle' 
                        },
                        {
                            table: {
                                headerRows: 1,
                                widths: finalWidths,
                                body: tableBody,
                                dontBreakRows: false
                            },
                            layout: {
                                fillColor: function (rowIndex, node, columnIndex) {
                                    return (rowIndex === 0) ? '#e8e8e8' : ((rowIndex % 2 === 0) ? '#f9f9f9' : null);
                                },
                                hLineWidth: function (i, node) {
                                    return (i === 0 || i === 1 || i === node.table.body.length) ? 2 : 1;
                                },
                                vLineWidth: function (i, node) {
                                    return 1;
                                },
                                hLineColor: function (i, node) {
                                    return '#000';
                                },
                                vLineColor: function (i, node) {
                                    return '#000';
                                },
                                paddingLeft: function(i, node) { return 6; },
                                paddingRight: function(i, node) { return 6; },
                                paddingTop: function(i, node) { return 8; },
                                paddingBottom: function(i, node) { return 8; }
                            }
                        }
                    ],
                    styles: {
                        title: { 
                            fontSize: 20, 
                            bold: true, 
                            alignment: 'center',
                            margin: [0, 10, 0, 15] 
                        },
                        subtitle: { 
                            fontSize: 12, 
                            alignment: 'center',
                            margin: [0, 0, 0, 20],
                            color: '#666'
                        },
                        tableHeader: { 
                            fontSize: 12, 
                            bold: true, 
                            alignment: 'center'
                        },
                        tableCell: { 
                            fontSize: 11, 
                            alignment: 'center'
                        }
                    },
                    pageOrientation: 'landscape',
                    pageSize: 'A3',
                    pageMargins: [20, 30, 20, 30]
                };

                const filename = `${saleTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_shortlist.pdf`;
                pdfMake.createPdf(docDefinition).download(filename);
            }

            printTable() {
                if (this.combinedData.length === 0) {
                    alert('No data to print. Please load some data first.');
                    return;
                }
                
                // Get current sale info for title
                const saleInfo = this.currentSaleId ? this.salesData.get(this.currentSaleId) : null;
                const saleTitle = saleInfo ? saleInfo.saleName : 'Combined Shortlist';
                
                // Create or update print title element
                let printTitle = document.getElementById('printTitle');
                if (!printTitle) {
                    printTitle = document.createElement('h1');
                    printTitle.id = 'printTitle';
                    printTitle.style.cssText = 'display: none; text-align: center; font-weight: bold; margin: 20px 0; font-size: 24px;';
                    document.body.insertBefore(printTitle, document.body.firstChild);
                }
                printTitle.textContent = saleTitle;
                
                // Add dynamic classes to table columns for print formatting
                this.addPrintColumnClasses();
                
                // Open print dialog
                window.print();
            }
            
            addPrintColumnClasses() {
                const table = document.getElementById('mainTable');
                if (!table) return;
                
                // Get all visible header cells (excluding delete column)
                const headerCells = Array.from(table.querySelectorAll('thead th')).filter(th => 
                    !th.querySelector('.delete-horse-btn') && 
                    th.style.display !== 'none' &&
                    !th.classList.contains('d-none')
                );
                
                const totalColumns = headerCells.length;
                
                // Define priority column types and their preferred relative sizes
                const columnTypes = {
                    hip: { priority: 1, preferredSize: 4 },
                    name: { priority: 1, preferredSize: 12 },
                    sex: { priority: 1, preferredSize: 2 },
                    yob: { priority: 1, preferredSize: 4 },
                    sire: { priority: 2, preferredSize: 8 },
                    dam: { priority: 2, preferredSize: 8 },
                    consignor: { priority: 2, preferredSize: 7 },
                    notes: { priority: 2, preferredSize: 7 },
                    vet: { priority: 3, preferredSize: 22 },
                    result: { priority: 3, preferredSize: 6 },
                    scope: { priority: 2, preferredSize: 4 },
                    reserve: { priority: 2, preferredSize: 7 },
                    overlap: { priority: 1, preferredSize: 4 },
                    notes: { priority: 2, preferredSize: 8 }
                };
                
                // Categorize columns and calculate total preferred size
                const identifiedColumns = [];
                let totalPreferredSize = 0;
                let shortlistColumns = 0;
                
                headerCells.forEach((th, index) => {
                    const headerText = th.textContent.trim().toLowerCase();
                    const columnIndex = index + 1;
                    
                    let columnType = null;
                    let preferredSize = 4; // Default for grade/shortlist columns
                    
                    // Check if it's a blank column (no header text) or the far right column
                    if (!headerText || headerText.trim() === '' || index === headerCells.length - 1) {
                        // Special handling for far right column - always make it small
                        if (index === headerCells.length - 1 && (!headerText || headerText.trim() === '')) {
                            columnType = 'blank-right';
                            preferredSize = 1;
                        } else if (!headerText || headerText.trim() === '') {
                            columnType = 'blank';
                            preferredSize = 1;
                        } else {
                            // It's the far right column but has text, process normally
                            // Identify column type
                            for (const [type, config] of Object.entries(columnTypes)) {
                                if (headerText.includes(type)) {
                                    columnType = type;
                                    preferredSize = config.preferredSize;
                                    break;
                                }
                            }
                            
                            if (!columnType) {
                                shortlistColumns++;
                                columnType = 'shortlist';
                                // Keep preferredSize = 4 for grade columns
                            }
                        }
                    } else {
                        // Identify column type
                        for (const [type, config] of Object.entries(columnTypes)) {
                            if (headerText.includes(type)) {
                                columnType = type;
                                preferredSize = config.preferredSize;
                                break;
                            }
                        }
                        
                        if (!columnType) {
                            shortlistColumns++;
                            columnType = 'shortlist';
                            // Keep preferredSize = 4 for grade columns
                        }
                    }
                    
                    identifiedColumns.push({
                        element: th,
                        columnIndex,
                        type: columnType,
                        preferredSize,
                        headerText
                    });
                    
                    totalPreferredSize += preferredSize;
                });
                
                // Calculate scaling factor to fit everything in 100%
                const scalingFactor = 100 / totalPreferredSize;
                
                // Apply dynamic widths and classes
                identifiedColumns.forEach(column => {
                    const actualWidth = Math.max(2, Math.round(column.preferredSize * scalingFactor));
                    
                    // Remove any existing print classes
                    column.element.className = column.element.className.replace(/print-\w+-header/g, '');
                    
                    // Add appropriate class and set width
                    const className = `print-${column.type}-header`;
                    column.element.classList.add(className);
                    
                    // Apply to corresponding cells
                    table.querySelectorAll(`tbody td:nth-child(${column.columnIndex})`).forEach(td => {
                        td.className = td.className.replace(/print-\w+-cell/g, '');
                        td.classList.add(`print-${column.type}-cell`);
                    });
                    
                    // Set CSS custom property for this column
                    document.documentElement.style.setProperty(`--print-col-${column.columnIndex}-width`, `${actualWidth}%`);
                });
                
                // Log the calculation for debugging
                console.log(`Print layout: ${totalColumns} columns, scaling factor: ${scalingFactor.toFixed(3)}`);
                console.log('Column widths:', identifiedColumns.map(col => `${col.type}: ${Math.round(col.preferredSize * scalingFactor)}%`));
            }

            showAddColumnModal() {
                const modal = new bootstrap.Modal(document.getElementById('addColumnModal'));
                modal.show();
            }

            addCustomColumn() {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                const name = document.getElementById('columnName').value.trim();
                const type = document.getElementById('columnType').value;
                
                if (!name) {
                    alert('Please enter a column name');
                    return;
                }

                if (this.columnOrder.includes(name)) {
                    alert('Column already exists');
                    return;
                }

                // Add column to data
                this.combinedData.forEach(row => {
                    row[name] = '';
                });

                this.customColumns.push(name);
                
                // Add to columnOrder in a better position (after Notes/shortlists but before trailing columns)
                const trailingColumns = ['Scope', 'Vet', 'Reserve', 'Result', 'Overlap'];
                const firstTrailingIndex = this.columnOrder.findIndex(col => trailingColumns.includes(col));
                
                if (firstTrailingIndex !== -1) {
                    // Insert before the first trailing column
                    this.columnOrder.splice(firstTrailingIndex, 0, name);
                } else {
                    // If no trailing columns found, add to end
                    this.columnOrder.push(name);
                }
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after adding custom column

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal')).hide();
                
                // Clear form
                document.getElementById('columnName').value = '';
                document.getElementById('columnType').value = 'text';
            }



            async loadFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const data = urlParams.get('data');
                
                if (data) {
                    try {
                        const parsed = JSON.parse(atob(data));
                        this.files = parsed.files || [];
                        this.customColumns = parsed.customColumns || [];
                        
                        if (this.files.length > 0) {
                            this.updateFileList();
                            this.updateCombineButton();
                            await this.combineData();
                        }
                    } catch (e) {
                        console.error('Error loading shared data:', e);
                    }
                }
            }

            clearAll() {
                this.files = [];
                this.combinedData = [];
                this.customColumns = [];
                
                if (this.table) {
                    this.table.destroy();
                    this.table = null;
                }
                
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
                document.querySelector('#mainTable thead').innerHTML = '';
                document.querySelector('#mainTable tbody').innerHTML = '';
                
                this.updateCombineButton();
            }

            // ========== ADMIN FUNCTIONALITY ==========

            addAdminButton() {
                // Add hidden admin button to page - only visible on specific key combo
                const adminBtn = document.createElement('button');
                adminBtn.id = 'hiddenAdminBtn';
                adminBtn.innerHTML = 'Admin';
                adminBtn.className = 'btn btn-sm btn-secondary';
                adminBtn.style.position = 'fixed';
                adminBtn.style.bottom = '10px';
                adminBtn.style.right = '10px';
                adminBtn.style.display = 'none';
                adminBtn.style.zIndex = '9999';
                adminBtn.addEventListener('click', () => this.showPinModal());
                document.body.appendChild(adminBtn);

                // Show admin button on Ctrl+Shift+A
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                        adminBtn.style.display = adminBtn.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            showPinModal() {
                document.getElementById('adminPin').value = '';
                document.getElementById('pinError').style.display = 'none';
                const modal = new bootstrap.Modal(document.getElementById('pinModal'));
                modal.show();
            }

            verifyPin() {
                const enteredPin = document.getElementById('adminPin').value;
                if (enteredPin === this.ADMIN_PIN) {
                    this.isAdmin = true;
                    this.startAdminSession();
                    bootstrap.Modal.getInstance(document.getElementById('pinModal')).hide();
                    this.showAdminPanel();
                } else {
                    document.getElementById('pinError').style.display = 'block';
                    document.getElementById('adminPin').value = '';
                }
            }

            startAdminSession() {
                // Clear any existing timeout
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                }

                // Set new timeout
                this.adminSessionTimeout = setTimeout(() => {
                    this.exitAdminMode();
                }, this.ADMIN_TIMEOUT);

                // Store admin status (temporary, will expire)
                localStorage.setItem('admin_session', Date.now().toString());
            }

            exitAdminMode() {
                this.isAdmin = false;
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                    this.adminSessionTimeout = null;
                }
                localStorage.removeItem('admin_session');
                
                // Close any open admin modals
                const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminPanelModal'));
                if (adminModal) {
                    adminModal.hide();
                }

                // Update UI to reflect non-admin state
                this.updateSaleSelector();
            }

            showAdminPanel() {
                this.populateAdminSalesList();
                const modal = new bootstrap.Modal(document.getElementById('adminPanelModal'));
                modal.show();
            }

            populateAdminSalesList() {
                const container = document.getElementById('adminSalesList');
                container.innerHTML = '';

                if (this.salesData.size === 0) {
                    container.innerHTML = '<p class="text-muted">No sales created yet</p>';
                    return;
                }

                this.salesData.forEach((saleInfo, saleId) => {
                    const isFrozen = this.isSaleFrozen(saleId);
                    const div = document.createElement('div');
                    div.className = 'border rounded p-3 mb-2';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${saleInfo.saleName}</strong>
                                <small class="text-muted d-block">${saleInfo.saleDate} - ${saleInfo.location || 'No location'}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-info" onclick="combiner.showCopySaleModal('${saleId}')">Copy</button>
                                <span class="badge ${isFrozen ? 'bg-danger' : 'bg-success'}">${isFrozen ? 'FROZEN' : 'Active'}</span>
                                <button class="btn btn-sm ${isFrozen ? 'btn-success' : 'btn-warning'}" onclick="combiner.toggleSaleFreeze('${saleId}')">
                                    ${isFrozen ? 'Unfreeze' : 'Freeze'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="combiner.deleteSaleAsAdmin('${saleId}')">Delete</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                // Also populate column deletion dropdown for current sale
                this.populateDeleteColumnDropdown();
            }
            
            populateDeleteColumnDropdown() {
                const select = document.getElementById('deleteColumnSelect');
                select.innerHTML = '<option value="">Select a column to delete...</option>';
                
                // Only show columns if there's a current sale with data
                if (!this.currentSaleId || this.combinedData.length === 0) {
                    select.disabled = true;
                    document.getElementById('deleteColumnBtn').disabled = true;
                    return;
                }
                
                select.disabled = false;
                
                // Get all column names from the table
                const sampleRow = this.combinedData[0];
                if (!sampleRow) return;
                
                // Get columns that can be deleted (exclude essential columns)
                const protectedColumns = ['Hip', 'Name', 'Sire', 'Dam', 'Sex', 'YOB', 'Consignor', 'Overlap'];
                const deletableColumns = Object.keys(sampleRow).filter(col => 
                    !protectedColumns.includes(col) && 
                    col !== '_uniqueId' &&
                    !col.startsWith('_')
                );
                
                if (deletableColumns.length === 0) {
                    select.innerHTML = '<option value="">No deletable columns available</option>';
                    select.disabled = true;
                    return;
                }
                
                // Add each deletable column as an option
                deletableColumns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    select.appendChild(option);
                });
            }
            
            async deleteColumnAsAdmin() {
                if (!this.isAdmin) return;
                
                const select = document.getElementById('deleteColumnSelect');
                const columnName = select.value;
                
                if (!columnName) {
                    alert('Please select a column to delete.');
                    return;
                }
                
                if (!confirm(`Are you sure you want to delete the "${columnName}" column?\n\nThis action cannot be undone and will affect all users.`)) {
                    return;
                }
                
                try {
                    // Remove the column from all rows in combinedData
                    this.combinedData.forEach(row => {
                        delete row[columnName];
                    });
                    
                    // Remove from custom columns if it exists there
                    this.customColumns = this.customColumns.filter(col => col !== columnName);
                    
                    // Remove from column order and hidden columns
                    this.columnOrder = this.columnOrder.filter(col => col !== columnName);
                    this.hiddenColumns.delete(columnName);
                    
                    // Remove from files array if it's a shortlist column (person name)
                    this.files = this.files.filter(file => file.name !== columnName);
                    
                    // Force global column deletion by storing deleted columns in sale data
                    const saleInfo = this.salesData.get(this.currentSaleId);
                    if (!saleInfo.deletedColumns) {
                        saleInfo.deletedColumns = [];
                    }
                    if (!saleInfo.deletedColumns.includes(columnName)) {
                        saleInfo.deletedColumns.push(columnName);
                    }
                    
                    // Save user preferences to persist the column removal
                    this.saveUserColumnPreferences();
                    
                    // Rebuild the entire table structure to reflect column removal
                    this.createTable();
                    this.updateStats();
                    
                    // Update file list display to reflect removed shortlist
                    this.updateFileList();
                    
                    // Save the changes to ensure all users see the column removal
                    await this.autoSave();
                    
                    // Refresh the column controls to remove from show/hide options
                    this.setupColumnControls();
                    
                    // Refresh the admin dropdown
                    this.populateDeleteColumnDropdown();
                    
                    alert('Column deleted successfully.');
                    
                } catch (error) {
                    console.error('Error deleting column:', error);
                    alert('Failed to delete column. Please try again.');
                }
            }

            isSaleFrozen(saleId) {
                if (!this.salesData.has(saleId)) return false;
                const saleInfo = this.salesData.get(saleId);
                return saleInfo.frozen || false;
            }

            async toggleSaleFreeze(saleId) {
                if (!this.salesData.has(saleId)) return;
                
                const saleInfo = this.salesData.get(saleId);
                saleInfo.frozen = !saleInfo.frozen;
                this.salesData.set(saleId, saleInfo);
                
                await this.saveSalesData();
                this.populateAdminSalesList();
            }


            checkIfSaleFrozen() {
                if (!this.currentSaleId) return false;
                return this.isSaleFrozen(this.currentSaleId);
            }

            showFrozenError() {
                alert('Unable to save changes. Please try again later.');
            }

            // ========== ADMIN FUNCTIONALITY ==========
            
            addAdminButton() {
                // Add hidden LOST numbers button as easter egg
                const adminBtn = document.createElement('button');
                adminBtn.id = 'hiddenAdminBtn';
                adminBtn.innerHTML = '>: 4 8 15 16 23';
                adminBtn.style.position = 'fixed';
                adminBtn.style.bottom = '10px';
                adminBtn.style.right = '10px';
                adminBtn.style.display = 'none';
                adminBtn.style.zIndex = '9999';
                adminBtn.style.padding = '4px 8px';
                adminBtn.style.fontSize = '12px';
                adminBtn.style.fontWeight = 'normal';
                adminBtn.style.fontFamily = 'Monaco, "Lucida Console", "Courier New", monospace';
                adminBtn.style.backgroundColor = '#000000';
                adminBtn.style.color = '#00cc00';
                adminBtn.style.border = '1px solid rgba(0, 204, 0, 0.3)';
                adminBtn.style.borderRadius = '2px';
                adminBtn.style.boxShadow = '0 0 4px rgba(0, 204, 0, 0.3)';
                adminBtn.style.textShadow = '0 0 2px rgba(0, 204, 0, 0.6)';
                adminBtn.style.cursor = 'pointer';
                adminBtn.style.transition = 'all 0.3s ease';
                adminBtn.style.letterSpacing = '1px';

                adminBtn.onmouseenter = () => {
                    adminBtn.style.boxShadow = '0 0 6px rgba(0, 204, 0, 0.5)';
                    adminBtn.style.textShadow = '0 0 3px rgba(0, 204, 0, 0.8)';
                    adminBtn.style.border = '1px solid rgba(0, 204, 0, 0.5)';
                };
                adminBtn.onmouseleave = () => {
                    adminBtn.style.boxShadow = '0 0 4px rgba(0, 204, 0, 0.3)';
                    adminBtn.style.textShadow = '0 0 2px rgba(0, 204, 0, 0.6)';
                    adminBtn.style.border = '1px solid rgba(0, 204, 0, 0.3)';
                };

                adminBtn.addEventListener('click', () => this.showPinModal());
                document.body.appendChild(adminBtn);

                // Get the existing 815 admin button next to Combined Shortlist
                const mobileAdminBtn = document.getElementById('admin815btn');
                if (mobileAdminBtn) {
                    mobileAdminBtn.addEventListener('click', () => this.showPinModal());
                    // Force very light gray color to override any other styling
                    mobileAdminBtn.style.color = '#f0f0f0';
                    mobileAdminBtn.style.borderColor = '#f0f0f0';
                    mobileAdminBtn.style.backgroundColor = 'transparent';
                }

                // Show admin button on Ctrl+Shift+A (desktop)
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                        adminBtn.style.display = adminBtn.style.display === 'none' ? 'block' : 'none';
                    }
                });

                // 815 button visibility is now controlled by CSS media queries

                // Add triple-tap backup method on header
                let logoTapCount = 0;
                const header = document.querySelector('h2');
                if (header) {
                    header.addEventListener('click', () => {
                        logoTapCount++;
                        if (logoTapCount >= 3) {
                            logoTapCount = 0;
                            adminBtn.style.display = adminBtn.style.display === 'none' ? 'block' : 'none';
                            if (mobileAdminBtn) {
                                mobileAdminBtn.style.display = mobileAdminBtn.style.display === 'none' ? 'inline-block' : 'none';
                            }
                        }
                        setTimeout(() => { logoTapCount = 0; }, 2000);
                    });
                }
            }

            showPinModal() {
                document.getElementById('adminPin').value = '';
                document.getElementById('pinError').style.display = 'none';
                const modal = new bootstrap.Modal(document.getElementById('pinModal'));
                modal.show();
            }


            startAdminSession() {
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                }

                this.adminSessionTimeout = setTimeout(() => {
                    this.exitAdminMode();
                }, this.ADMIN_TIMEOUT);

                localStorage.setItem('admin_session', Date.now().toString());
            }

            exitAdminMode() {
                this.isAdmin = false;
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                    this.adminSessionTimeout = null;
                }
                localStorage.removeItem('admin_session');
                this.updateAdminButtonVisibility();

                const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminPanelModal'));
                if (adminModal) {
                    adminModal.hide();
                }
            }


            async deleteSaleAsAdmin(saleId) {
                if (!this.isAdmin) return;
                
                if (confirm(`Are you sure you want to delete the sale "${saleId}"? This action cannot be undone.`)) {
                    try {
                        // Delete from server/Redis
                        const response = await fetch(`https://solis-litt-sales.vercel.app/api/sales?saleId=${saleId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to delete sale from server');
                        }
                        
                        // Delete from local memory
                        this.salesData.delete(saleId);
                        
                        // Remove from frozen list if it was frozen
                        const frozenSales = JSON.parse(localStorage.getItem('frozen_sales') || '[]');
                        const index = frozenSales.indexOf(saleId);
                        if (index > -1) {
                            frozenSales.splice(index, 1);
                            localStorage.setItem('frozen_sales', JSON.stringify(frozenSales));
                        }
                        
                        // If this was the current sale, reset
                        if (this.currentSaleId === saleId) {
                            this.currentSaleId = null;
                            localStorage.removeItem('currentSaleId'); // Clear saved sale
                            this.files = [];
                            this.combinedData = [];
                            this.createTable();
                            this.updateSaleSelector();
                        }
                        
                        // Update UI
                        this.populateAdminSalesList();
                        this.updateSaleSelector();
                        
                        alert('Sale deleted successfully');
                        
                    } catch (error) {
                        console.error('Error deleting sale:', error);
                        alert('Failed to delete sale. Please try again.');
                    }
                }
            }

            showCopySaleModal(saleId) {
                if (!this.isAdmin) return;
                
                // Store the sale ID to copy
                this.saleIdToCopy = saleId;
                
                // Clear form fields
                document.getElementById('newSaleName').value = '';
                document.getElementById('newSaleDate').value = '';
                document.getElementById('newSaleLocation').value = '';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('copySaleModal'));
                modal.show();
            }

            async copySale() {
                if (!this.isAdmin || !this.saleIdToCopy) return;
                
                const newSaleName = document.getElementById('newSaleName').value.trim();
                if (!newSaleName) {
                    alert('Please enter a name for the new sale');
                    return;
                }
                
                const newSaleDate = document.getElementById('newSaleDate').value || new Date().toISOString().split('T')[0];
                const newSaleLocation = document.getElementById('newSaleLocation').value.trim();
                
                try {
                    // Generate new sale ID
                    const newSaleId = newSaleName.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
                    
                    // Get the original sale data (ensure it's fully loaded)
                    let originalSaleInfo = this.salesData.get(this.saleIdToCopy);
                    if (!originalSaleInfo) {
                        throw new Error('Original sale not found');
                    }
                    
                    // Check if the sale data is fully loaded (has actual horse data)
                    if (!originalSaleInfo.data || !originalSaleInfo.data.combinedData) {
                        // Data not loaded yet, need to fetch it from server
                        console.log('Original sale data not fully loaded, fetching from server...');
                        
                        // Get all sales data fresh from server
                        const salesResponse = await fetch('https://solis-litt-sales.vercel.app/api/sales');
                        if (!salesResponse.ok) {
                            throw new Error('Failed to fetch sales data from server');
                        }
                        
                        const salesResult = await salesResponse.json();
                        if (!salesResult.sales || !salesResult.sales[this.saleIdToCopy]) {
                            throw new Error('Original sale not found on server');
                        }
                        
                        // Update local copy with full data
                        originalSaleInfo = salesResult.sales[this.saleIdToCopy];
                        this.salesData.set(this.saleIdToCopy, originalSaleInfo);
                        
                        // Double-check we now have the data
                        if (!originalSaleInfo.data || !originalSaleInfo.data.combinedData) {
                            throw new Error('Original sale has no horse data to copy');
                        }
                    }
                    
                    // Create the complete new sale data structure by copying from original
                    const newSaleData = {
                        saleName: newSaleName,
                        saleDate: newSaleDate,
                        location: newSaleLocation || originalSaleInfo.location || '',
                        hipUrlTemplate: originalSaleInfo.hipUrlTemplate || '', // Copy the URL template
                        // Deep copy the original sale data to avoid reference issues
                        data: originalSaleInfo.data ? JSON.parse(JSON.stringify(originalSaleInfo.data)) : {
                            files: [],
                            combinedData: [],
                            customColumns: [],
                            sortState: {},
                            filters: {}
                        },
                        // Copy other properties that might exist
                        frozen: false, // New sale should not be frozen by default
                        deletedColumns: originalSaleInfo.deletedColumns ? [...originalSaleInfo.deletedColumns] : []
                    };
                    
                    // Save complete new sale to server using the existing sales endpoint
                    const saveResponse = await fetch('https://solis-litt-sales.vercel.app/api/sales', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            saleId: newSaleId,
                            saleData: newSaleData
                        })
                    });
                    
                    if (!saveResponse.ok) {
                        throw new Error('Failed to save copied sale');
                    }
                    
                    // Add to local memory
                    this.salesData.set(newSaleId, newSaleData);
                    
                    // Update UI
                    this.populateAdminSalesList();
                    this.updateSaleSelector();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('copySaleModal'));
                    modal.hide();
                    
                    // Clear stored sale ID
                    this.saleIdToCopy = null;
                    
                    alert(`Sale copied successfully as "${newSaleName}"`);
                    
                } catch (error) {
                    console.error('Error copying sale:', error);
                    alert('Failed to copy sale. Please try again.');
                }
            }


            updateAdminButtonVisibility() {
                // Show/hide Clear button based on admin status
                const clearBtn = document.getElementById('clearBtn');
                if (clearBtn) {
                    clearBtn.style.display = this.isAdmin ? 'inline-block' : 'none';
                }
            }

            // ========== iPad TABLE FIX ==========
            
            fixiPadTable() {
                // Only apply mobile fixes on mobile devices
                if (window.innerWidth <= 1024) {
                    const table = document.getElementById('mainTable');
                    if (table) {
                        const container = table.closest('.table-container');
                        if (container) {
                            // Calculate dynamic height based on screen size and orientation
                            const isPortrait = window.innerHeight > window.innerWidth;
                            
                            // Detect device type based on screen dimensions
                            const screenWidth = window.screen.width;
                            const screenHeight = window.screen.height;
                            const isIPhone = (screenWidth <= 428 && screenHeight <= 926) || (screenWidth <= 926 && screenHeight <= 428);
                            const isIPad = !isIPhone && window.innerWidth <= 1024;
                            
                            // Calculate actual space used by elements above the table
                            let usedHeight = 0;
                            
                            // Measure actual heights of elements above table
                            const navbar = document.querySelector('.navbar');
                            const statsRow = document.querySelector('.stats-row');
                            const controlsRow = document.querySelector('.card-header');
                            
                            if (navbar) usedHeight += navbar.offsetHeight;
                            if (statsRow) usedHeight += statsRow.offsetHeight;
                            if (controlsRow) usedHeight += controlsRow.offsetHeight;
                            
                            // Device and orientation specific adjustments
                            let buffer, minHeight;
                            
                            if (isIPhone) {
                                if (isPortrait) {
                                    buffer = 120; // Slightly less tall for iPhone portrait
                                    minHeight = 500;
                                } else {
                                    buffer = 200; // Significantly smaller on iPhone landscape
                                    minHeight = 200;
                                }
                            } else if (isIPad) {
                                if (isPortrait) {
                                    buffer = -70; // 120px taller (50 - 120 = -70)
                                    minHeight = 870; // Increased by 120px (750 + 120)
                                } else {
                                    buffer = 600; // Significantly smaller for iPad landscape
                                    minHeight = 250; // Much more compact
                                }
                            } else {
                                // Default for other devices
                                buffer = isPortrait ? 100 : 80;
                                minHeight = isPortrait ? 600 : 450;
                            }
                            
                            const totalUsedHeight = usedHeight + buffer;
                            const availableHeight = window.innerHeight - totalUsedHeight;
                            const containerHeight = Math.max(availableHeight, minHeight);
                            
                            console.log(`Device: ${isIPhone ? 'iPhone' : isIPad ? 'iPad' : 'Other'}, Portrait: ${isPortrait}, Screen: ${window.innerHeight}, Used: ${totalUsedHeight}, Container: ${containerHeight}`);
                            
                            // Set dynamic container height
                            container.style.height = `${containerHeight}px`;
                            container.style.overflow = 'auto';
                            container.style.webkitOverflowScrolling = 'touch';
                            container.style.position = 'relative';
                            
                            // Portrait mode needs special treatment
                            if (isPortrait) {
                                // Force a different approach for portrait - make thead sticky
                                const thead = table.querySelector('thead');
                                if (thead) {
                                    thead.style.position = '-webkit-sticky';
                                    thead.style.position = 'sticky';
                                    thead.style.top = '0';
                                    thead.style.zIndex = '999';
                                    thead.style.backgroundColor = '#f8f9fa';
                                }
                            }
                            
                            // Force sticky headers for mobile Safari
                            const headers = table.querySelectorAll('thead th');
                            headers.forEach(th => {
                                th.style.position = '-webkit-sticky';
                                th.style.position = 'sticky';
                                th.style.top = '0';
                                th.style.zIndex = isPortrait ? '999' : '100';
                                th.style.backgroundColor = '#f8f9fa';
                                
                                // Add visual separation in portrait
                                if (isPortrait) {
                                    th.style.borderBottom = '2px solid #d0d7de';
                                    th.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                }
                            });
                            
                            // Keep table border-collapse normal
                            table.style.borderCollapse = 'collapse';
                            
                            // Force reflow
                            container.offsetHeight;
                        }
                    }
                }
            }

            // ========== NEW HORSE FUNCTIONALITY ==========
            
            addNewHorse() {
                if (this.combinedData.length === 0) {
                    alert('Please upload at least one shortlist file before adding a new horse.');
                    return;
                }

                // Clear any existing filters temporarily to ensure new horse appears at top
                this.filters = {};
                
                // Create a new blank horse with all current columns
                const newHorse = {};
                const allColumns = new Set();
                
                // Get all possible columns from existing data
                this.combinedData.forEach(horse => {
                    Object.keys(horse).forEach(key => allColumns.add(key));
                });
                
                // Initialize all columns with empty values
                allColumns.forEach(column => {
                    if (column === '_uniqueId') return; // Skip internal fields
                    newHorse[column] = '';
                });
                
                // Set default values
                const timestamp = Date.now();
                newHorse['Hip'] = 'NEW';
                newHorse['Name'] = 'New Horse';
                newHorse['Overlap'] = 0;
                newHorse['_uniqueId'] = timestamp;

                // SAVE UNDO STATE BEFORE ADDING - completely safe
                this.saveUndoState('add', {
                    addedRow: JSON.parse(JSON.stringify(newHorse)), // deep copy
                    hip: newHorse['Hip'] || 'NEW'
                });
                
                // Add to beginning of data array (existing logic unchanged)
                this.combinedData.unshift(newHorse);
                
                // Recreate table
                this.createTable();
                this.updateStats();
                
                // Save the changes
                console.log('New horse added, saving for all users...');
                this.saveSaleDay(this.currentSaleId);
                
                alert('New horse added at the top of the list. Click any cell to edit the horse details.');
            }
            
            // Edit Lock System Methods
            generateUserId() {
                // Generate a simple unique user ID for this session
                return 'user_' + Math.random().toString(36).substr(2, 9);
            }

            startViewRefresh() {
                // Only start if we have a current sale and we're not editing
                if (!this.currentSaleId || this.isEditMode) {
                    console.log('Auto-refresh not started:', !this.currentSaleId ? 'No sale selected' : 'In edit mode');
                    return;
                }
                
                // Clear any existing interval
                this.stopViewRefresh();
                
                console.log('Starting auto-refresh every 3 minutes in view mode');
                
                // Refresh every 3 minutes in view mode
                this.viewRefreshInterval = setInterval(async () => {
                    if (!this.isEditMode && this.currentSaleId) {
                        console.log('Auto-refreshing data...');
                        await this.refreshWithScrollPreservation();
                    }
                }, 3 * 60 * 1000); // 3 minutes
            }

            stopViewRefresh() {
                if (this.viewRefreshInterval) {
                    clearInterval(this.viewRefreshInterval);
                    this.viewRefreshInterval = null;
                }
            }

            async refreshWithScrollPreservation() {
                try {
                    // Save current scroll position
                    const tableContainer = document.querySelector('.table-container');
                    const scrollTop = tableContainer ? tableContainer.scrollTop : 0;
                    
                    // Refresh data
                    await this.refreshSaleData();
                    
                    // Restore scroll position after a short delay to allow table to render
                    setTimeout(() => {
                        if (tableContainer && scrollTop > 0) {
                            tableContainer.scrollTop = scrollTop;
                        }
                    }, 100);
                    
                    console.log('View refreshed with scroll position preserved');
                } catch (error) {
                    console.error('Failed to refresh view:', error);
                }
            }
            
            setupEditMode() {
                // Start in view-only mode
                this.setViewOnlyMode();
                
                // Setup edit mode button
                document.getElementById('editModeBtn').addEventListener('click', () => {
                    if (this.isEditMode) {
                        this.exitEditMode();
                    } else {
                        this.requestEditMode();
                    }
                });
                
                // Track user activity for timeout
                document.addEventListener('keydown', () => this.updateActivity());
                document.addEventListener('click', () => this.updateActivity());
                document.addEventListener('mousemove', () => this.updateActivity());
                
                // Handle orientation changes and window resizing for mobile
                window.addEventListener('resize', () => {
                    if (window.innerWidth <= 1024) {
                        setTimeout(() => {
                            this.fixiPadTable();
                        }, 100); // Small delay for orientation change completion
                    }
                });
                
                window.addEventListener('orientationchange', () => {
                    if (window.innerWidth <= 1024) {
                        setTimeout(() => {
                            this.fixiPadTable();
                        }, 300); // Longer delay for orientation change
                    }
                });
                
                // Release lock when page is closed/refreshed
                window.addEventListener('beforeunload', () => {
                    if (this.isEditMode) {
                        // Use synchronous request for reliability on page unload
                        navigator.sendBeacon('https://solis-litt-sales.vercel.app/api/edit-lock', 
                            JSON.stringify({
                                action: 'release',
                                saleId: this.currentSaleId,
                                userId: this.userId
                            })
                        );
                    }
                });
            }
            
            setViewOnlyMode() {
                this.isEditMode = false;
                document.querySelector('.card').classList.add('view-only-mode');
                document.querySelector('.card').classList.remove('edit-mode-active');
                
                const editBtn = document.getElementById('editModeBtn');
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                editBtn.className = 'btn btn-primary';
                editBtn.style.backgroundColor = '';
                editBtn.style.color = '';
                editBtn.style.borderColor = '';
                editBtn.title = 'Click to enable editing';
                
                // Clear any existing timeout
                if (this.editLockTimeout) {
                    clearTimeout(this.editLockTimeout);
                    this.editLockTimeout = null;
                }
                
                // Start view mode auto-refresh
                this.startViewRefresh();
            }
            
            setEditMode() {
                this.isEditMode = true;
                document.querySelector('.card').classList.remove('view-only-mode');
                document.querySelector('.card').classList.add('edit-mode-active');
                
                const editBtn = document.getElementById('editModeBtn');
                editBtn.innerHTML = '<i class="fas fa-lock"></i> Stop Editing';
                editBtn.className = 'btn';
                editBtn.style.backgroundColor = '#ff6600';
                editBtn.style.color = 'white';
                editBtn.style.borderColor = '#ff6600';
                editBtn.title = 'Click to stop editing and release lock';
                
                // Stop view refresh in edit mode
                this.stopViewRefresh();
                
                // Start activity timeout (15 minutes)
                this.startEditTimeout();
            }
            
            async requestEditMode() {
                if (!this.currentSaleId) {
                    alert('Please select a sale first');
                    return;
                }
                
                try {
                    const response = await fetch('https://solis-litt-sales.vercel.app/api/edit-lock', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'acquire',
                            saleId: this.currentSaleId,
                            userId: this.userId
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('Edit lock acquired');
                        
                        // Auto-refresh to get latest data before editing
                        console.log('Refreshing data before editing...');
                        await this.refreshSaleData();
                        
                        this.setEditMode();
                    } else {
                        // Handle different error cases
                        let errorMessage = 'Another user is currently editing this sale.';
                        if (result.error) {
                            errorMessage = result.error;
                        }
                        if (result.timeHeld !== undefined) {
                            errorMessage += `\nBeing edited for ${result.timeHeld} minute(s).`;
                        }
                        alert(errorMessage);
                    }
                } catch (error) {
                    console.error('Failed to request edit lock:', error);
                    alert('Unable to connect to server. You can still edit, but changes may conflict with other users.');
                    this.setEditMode(); // Allow editing in offline mode
                }
            }
            
            async exitEditMode() {
                try {
                    console.log('Attempting to release edit lock...');
                    const response = await fetch('https://solis-litt-sales.vercel.app/api/edit-lock', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'release',
                            saleId: this.currentSaleId,
                            userId: this.userId
                        })
                    });
                    
                    const result = await response.json();
                    console.log('Edit lock release response:', result);
                    
                    if (!result.success) {
                        console.error('Lock release failed:', result);
                    } else {
                        // Auto-refresh after stopping editing to show any changes made
                        // Add small delay to ensure save operations complete
                        console.log('Refreshing data after stopping edit...');
                        setTimeout(async () => {
                            await this.refreshSaleData();
                        }, 1000); // 1 second delay
                    }
                } catch (error) {
                    console.error('Failed to release edit lock:', error);
                    // Try alternative method using navigator.sendBeacon
                    try {
                        navigator.sendBeacon('https://solis-litt-sales.vercel.app/api/edit-lock', 
                            JSON.stringify({
                                action: 'release',
                                saleId: this.currentSaleId,
                                userId: this.userId
                            })
                        );
                        console.log('Backup lock release attempted with sendBeacon');
                    } catch (beaconError) {
                        console.error('Beacon release also failed:', beaconError);
                    }
                }
                
                this.setViewOnlyMode();
            }
            
            updateActivity() {
                this.lastActivity = Date.now();
                
                // Restart timeout if in edit mode
                if (this.isEditMode) {
                    this.startEditTimeout();
                }
            }
            
            startEditTimeout() {
                // Clear existing timeout
                if (this.editLockTimeout) {
                    clearTimeout(this.editLockTimeout);
                }
                
                // Set 3 minute timeout
                this.editLockTimeout = setTimeout(() => {
                    console.log('Edit mode timed out due to inactivity');
                    this.exitEditMode();
                    alert('Edit session expired due to 3 minutes of inactivity. Click Edit to resume editing.');
                }, 3 * 60 * 1000); // 3 minutes
            }
            
            async refreshSaleData() {
                try {
                    // Reload the current sale data from API
                    const response = await fetch('https://solis-litt-sales.vercel.app/api/sales');
                    const result = await response.json();
                    
                    if (response.ok && result.sales && this.currentSaleId) {
                        const freshSaleData = result.sales[this.currentSaleId];
                        if (freshSaleData && freshSaleData.data) {
                            // Preserve current column order during refresh
                            const currentColumnOrder = [...this.columnOrder];
                            
                            // Update local data with fresh data from API
                            this.combinedData = freshSaleData.data.combinedData || [];
                            this.files = freshSaleData.data.files || [];
                            this.customColumns = freshSaleData.data.customColumns || [];
                            
                            // Only update column order if we don't have one locally
                            if (currentColumnOrder.length === 0) {
                                this.columnOrder = freshSaleData.data.columnOrder || [];
                            } else {
                                this.columnOrder = currentColumnOrder; // Preserve user's column order
                            }
                            
                            // Recreate table with fresh data
                            this.createTable();
                            console.log('Sale data refreshed successfully');
                        }
                    }
                } catch (error) {
                    console.error('Failed to refresh sale data:', error);
                }
            }
            
            async adminForceEdit() {
                if (!this.isAdmin) {
                    alert('Admin access required');
                    return;
                }
                
                if (!this.currentSaleId) {
                    alert('Please select a sale first');
                    return;
                }
                
                const confirmed = confirm('This will kick out all users currently editing this sale and give you immediate edit access. Continue?');
                if (!confirmed) return;
                
                try {
                    // Force clear all locks for current sale
                    const response = await fetch('https://solis-litt-sales.vercel.app/api/edit-lock', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'admin_force',
                            saleId: this.currentSaleId,
                            userId: this.userId
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('Admin forced edit access');
                        
                        // Refresh data and enter edit mode
                        await this.refreshSaleData();
                        this.setEditMode();
                        
                        // Close admin panel
                        const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminPanelModal'));
                        if (adminModal) {
                            adminModal.hide();
                        }
                        
                        alert('Edit access granted. All other users have been kicked out of edit mode.');
                    } else {
                        alert('Failed to force edit access: ' + result.message);
                    }
                } catch (error) {
                    console.error('Failed to force edit access:', error);
                    alert('Failed to connect to server');
                }
            }
        }

        // Site Access PIN System (separate from admin PIN)
        function checkSiteAccess() {
            const siteAccess = localStorage.getItem('siteAccess');
            const siteTimestamp = localStorage.getItem('siteTimestamp');
            const currentTime = Date.now();
            
            // Check if PIN was entered and if it's been less than 12 hours (12 * 60 * 60 * 1000 = 43200000 ms)
            if (siteAccess === 'granted' && siteTimestamp) {
                const timeElapsed = currentTime - parseInt(siteTimestamp);
                if (timeElapsed < 43200000) { // 12 hours
                    return true; // Access granted, no need to show PIN
                }
            }
            
            // Show site access PIN modal
            document.getElementById('siteAccessModal').style.display = 'block';
            document.getElementById('siteAccessInput').focus();
            return false;
        }
        
        function checkSitePin() {
            const pinInput = document.getElementById('siteAccessInput');
            const pinError = document.getElementById('siteAccessError');
            const enteredPin = pinInput.value;
            
            if (enteredPin === '14066') {
                // Correct PIN
                localStorage.setItem('siteAccess', 'granted');
                localStorage.setItem('siteTimestamp', Date.now().toString());
                document.getElementById('siteAccessModal').style.display = 'none';
                pinError.style.display = 'none';
                pinInput.value = '';
            } else {
                // Incorrect PIN
                pinError.style.display = 'block';
                pinInput.value = '';
                pinInput.focus();
                
                // Shake animation
                pinInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    pinInput.style.animation = '';
                }, 500);
            }
        }
        
        // Allow Enter key to submit site access PIN (only when site access modal is visible)
        document.addEventListener('keydown', function(event) {
            const siteModal = document.getElementById('siteAccessModal');
            if (event.key === 'Enter' && 
                siteModal && 
                siteModal.style.display === 'block' && 
                document.activeElement === document.getElementById('siteAccessInput')) {
                checkSitePin();
            }
        });
        
        // Check site access when page loads
        window.addEventListener('load', function() {
            checkSiteAccess();
        });

        // Initialize the application
        window.combiner = new ShortlistCombiner();
    </script>
    
</body>
</html>